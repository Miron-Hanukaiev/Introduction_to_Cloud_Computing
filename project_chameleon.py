# -*- coding: utf-8 -*-
"""HW3_Chameleon.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1X3TYdKbDqkIj-YuWmnyOuYlV3E4I6snN

# ğŸ¦ Chameleon - Smart Plant Care System

---

### ğŸ¯ Project Overview

Chameleon is an intelligent plant care management system that combines:
- **Real-time sensor monitoring** (Temperature, Humidity, Soil Moisture)
- **AI-powered plant disease detection** using Hugging Face models
- **Smart search engine** with TF-IDF ranking and Cloud-based Inverted Index
- **Interactive chatbot** (NLTK + Google Gemini)
- **Gamification system** to encourage regular plant care

### ğŸ› ï¸ Technologies Used

| Category | Technologies |
|----------|-------------|
| **Backend/DB** | Firebase Realtime Database |
| **AI/ML** | Hugging Face Transformers, TF-IDF, NLTK, Google Gemini |
| **Data Processing** | PyMuPDF, Pandas, NumPy |
| **Visualization** | Matplotlib, ipywidgets |
| **Environment** | Google Colab |

### ğŸ“‹ Table of Contents
1. [Setup & Installations](#setup)
2. [Database Layer (Firebase)](#firebase)
3. [Sensor Data Management](#sensor)
4. [Document Processing & Indexing](#indexing)
5. [Search Engine & AI Features](#search-engine)
6. [Search Screen UI](#search-ui)
7. [Upload Functions & Home Screen Helpers](#upload-helpers)
8. [Home Screen (Dashboard)](#dashboard)
9. [Upload Screen (Plant Health Check)](#plant-check)
10. [Climate & Soil Monitoring](#climate)
11. [Logbook Screen](#logbook)
12. [Plant Bot (AI Chatbot)](#chatbot)
13. [Main Application (Navigation & Game)](#main-app)

---
# 1. Setup & Installations <a id="setup"></a>

Installing all required packages for the project.
"""

# Installations
!pip -q install git+https://github.com/ozgur/python-firebase.git firebase-admin pymupdf nltk scikit-learn ipywidgets google-generativeai transformers torch torchvision pillow

#imports
import json
import time
import threading
from datetime import datetime
from firebase import firebase
import re
import requests
from bs4 import BeautifulSoup
from collections import defaultdict
import urllib.parse
import nltk
nltk.download('punkt')
from nltk.stem import PorterStemmer
stemmer = PorterStemmer()
from urllib.parse import urljoin, urlparse
import ipywidgets as widgets
from IPython.display import display, clear_output, HTML, Image
from itertools import count
from google.colab import files
import firebase_admin
from firebase_admin import credentials, db
import base64
import matplotlib.pyplot as plt
import pandas as pd
from functools import partial
import random
import fitz
import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import html
import google.generativeai as genai
from transformers import pipeline
from PIL import Image as PILImage
import io
import warnings
warnings.filterwarnings("ignore")
from nltk.corpus import stopwords
nltk.download('stopwords', quiet=True)

"""---
# 2. Database Layer (Firebase) <a id="firebase"></a>

### ğŸ—„ï¸ Firebase Realtime Database Structure

```
firebase-root/
â”œâ”€â”€ index/              # Inverted index for search (term â†’ [doc1, doc2, ...])
â”œâ”€â”€ sensor_data/        # Sensor readings organized by type
â”‚   â”œâ”€â”€ temperature/    #   â†’ {value, timestamp}
â”‚   â”œâ”€â”€ humidity/       #   â†’ {value, timestamp}
â”‚   â””â”€â”€ soil/          #   â†’ {value, timestamp}
â”œâ”€â”€ plant_logs/         # User activity logs (watering, fertilizing, etc.)
â”œâ”€â”€ plant_uploads/      # Uploaded images stored as base64
â””â”€â”€ user_stats/         # Gamification data (XP points, coins)
```
"""

# DB connection
firebase_url = 'https://chameleon-hw2-default-rtdb.firebaseio.com/'
FBconn = firebase.FirebaseApplication(firebase_url, None)


INDEX_PATH = "/index"

def check_index_exists_in_firebase() -> bool:
    """
    Check if the index already exists in Firebase.
    Returns True if index exists and has data, False otherwise.
    """
    try:
        data = FBconn.get(INDEX_PATH, None)
        if data and len(data) > 0:
            return True
        return False
    except Exception as e:
        print(f"Error checking index existence: {e}")
        return False

def save_index_records_to_firebase(index_records: list):
    """
    index_records: list of dicts like {"term": "...", "DocIDs": [...]}
    Saves each term under /index/<term> so it is easy to retrieve and verify.
    """
    if not index_records:
        return

    for rec in index_records:
        term = rec.get("term")
        docids = rec.get("DocIDs", [])
        if not term:
            continue

        payload = {"term": term, "DocIDs": docids}

        # put() overwrites by term -> prevents duplicates
        FBconn.put(INDEX_PATH, term, payload)

def load_index_records_from_firebase(limit: int = 20) -> list:
    """
    Returns up to 'limit' records from Firebase for quick verification.
    """
    data = FBconn.get(INDEX_PATH, None)
    if not data:
        return []

    records = list(data.values())
    records.sort(key=lambda x: x.get("term", ""))
    return records[:limit]

#LOGBOOK FEATURE: FIREBASE HANDLERS
LOG_PATH = '/plant_logs'

def save_log_entry(action_type, notes):
    """Saves a maintenance log entry to Firebase."""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    entry = {
        "action": action_type,
        "notes": notes,
        "timestamp": timestamp
    }
    # post() creates a unique ID for each entry
    FBconn.post(LOG_PATH, entry)

def get_log_entries():
    """Retrieves maintenance logs from Firebase."""
    data = FBconn.get(LOG_PATH, None)
    if not data:
        return []

    # Convert dict of dicts to list of dicts
    logs = []
    for key, val in data.items():
        logs.append(val)

    # Sort by timestamp descending (newest first)
    logs.sort(key=lambda x: x['timestamp'], reverse=True)
    return logs

# SENSOR DATA FEATURE: SAVE TO FIREBASE
SENSOR_PATH = '/sensor_data'

def save_sensor_data(sensor_type, value, timestamp=None):
    """
    Saves a sensor reading to Firebase.
    sensor_type: 'temperature', 'humidity', or 'soil'
    value: The numerical value reading
    """


    # Create the payload
    entry = {
        "value": value,
        "timestamp": timestamp
    }

    # Save under a specific path for each sensor type
    FBconn.post(f"{SENSOR_PATH}/{sensor_type}", entry)

    #print(f"âœ… Saved {sensor_type}: {value} to Firebase")

def get_sensor_history_from_firebase(sensor_type, limit=30):
    """Retrieves sensor history from Firebase and returns unique timestamps only."""
    path = f"{SENSOR_PATH}/{sensor_type}"
    data = FBconn.get(path, None)

    if not data:
        return []

    records = list(data.values())

    # Keep only one record per timestamp (last one wins)
    unique_by_timestamp = {}
    for record in records:
        ts = record.get("timestamp")
        if ts is None:
            continue
        unique_by_timestamp[ts] = record

    # Sort by timestamp
    records = sorted(
        unique_by_timestamp.values(),
        key=lambda x: x.get("timestamp", "")
    )

    # Return only the last limit records
    return records[-limit:]


def delete_log_entry(entry_id):
    """Deletes a log entry from Firebase by its ID."""
    try:
        FBconn.delete(LOG_PATH, entry_id)
        return True
    except Exception as e:
        print(f"Error deleting log: {e}")
        return False

def get_log_entries_with_ids():
    """Retrieves maintenance logs from Firebase WITH their IDs (for deletion)."""
    data = FBconn.get(LOG_PATH, None)
    if not data:
        return []

    logs = []
    for key, val in data.items():
        val['id'] = key  # Store the Firebase key for deletion
        logs.append(val)

    logs.sort(key=lambda x: x['timestamp'], reverse=True)
    return logs

def show_toast(message, color="#2ecc71"):
    """
    Displays a temporary, animated floating notification (toast) at the top of the screen.
    The message slides down, stays for a few seconds, and then fades out.
    Used for gamification feedback like 'Mission Completed' or 'XP Earned'.
    """
    toast_id = f"toast_{int(time.time())}"

    display(HTML(f"""
    <div id="{toast_id}" style="
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: {color};
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        font-family: sans-serif;
        font-weight: bold;
        border: 2px solid white;
        animation: slideDownFade 3s forwards;
    ">
        âœ¨ {message} âœ¨
    </div>
    <style>
        @keyframes slideDownFade {{
            0% {{ opacity: 0; transform: translate(-50%, -20px); }}
            15% {{ opacity: 1; transform: translate(-50%, 0); }}
            85% {{ opacity: 1; transform: translate(-50%, 0); }}
            100% {{ opacity: 0; transform: translate(-50%, -20px); visibility: hidden; }}
        }}
    </style>
    """))

def add_reward(xp_to_add, coins_to_add=0):
    """
    Add XP and coins to user stats and show a single floating notification.
    """
    try:
        # --- Fetch current stats from Firebase ---
        stats = FBconn.get('/user_stats', None) or {"points": 0, "coins": 0}
        new_points = stats.get('points', 0) + xp_to_add
        new_coins = stats.get('coins', 0) + coins_to_add

        # --- Update Firebase ---
        FBconn.put('/user_stats', 'points', new_points)
        FBconn.put('/user_stats', 'coins', new_coins)

        # --- Create combined message ---
        parts = []
        if xp_to_add > 0:
            parts.append(f"+{xp_to_add} XP")
        if coins_to_add > 0:
            parts.append(f"ğŸ’° +{coins_to_add} Coins")
        message = " | ".join(parts)  # Single line
        show_toast(f"âœ¨ MISSION COMPLETED! âœ¨\n{message}")

    except Exception as e:
        print(f"Error adding reward: {e}")

"""---
# 3. Sensor Data Management <a id="sensor"></a>

### ğŸŒ¡ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Physical Sensorsâ”‚ â”€â”€â–º â”‚ Cloud Server     â”‚ â”€â”€â–º â”‚ Firebase DB  â”‚ â”€â”€â–º â”‚ Our App     â”‚
â”‚ (IoT Devices)   â”‚     â”‚ (Render.com)     â”‚     â”‚ (Realtime)   â”‚     â”‚ (Colab UI)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š Sensor Types

| Sensor | Range | Ideal Range | Unit |
|--------|-------|-------------|------|
| Temperature | 0-50 | 15-30 | Â°C |
| Humidity | 0-100 | 40-80 | % |
| Soil Moisture | 0-100 | 30-70 | % |

### ğŸ”„ Data Flow
1. **Fetch**: `get_data_from_sensors()` calls Render.com API
2. **Store**: Each reading saved to Firebase with timestamp
3. **Display**: Charts pull from Firebase history
4. **Refresh**: User can manually refresh or auto-fetch in background


"""

def get_data_from_sensors(change=60):
    BASE_URL = "https://server-cloud-v645.onrender.com/"
    FEEDS = ["soil", "temperature", "humidity"]

    # for each feed get the data
    for feed in FEEDS:
        # Send request to the server
        response = requests.get(
            f"{BASE_URL}/history",
            params={"feed": feed, "limit": change}
        )
        # Parse the response
        data = response.json()
        # change the records to be from the old to the new
        records = data["data"][::-1]

        for record in records:
            value = record['value']
            raw_time = record.get('created_at', '')
            save_sensor_data(feed, value, raw_time)

# Call the function
get_data_from_sensors()

"""---
# 4. Document Processing & Indexing <a id="indexing"></a>

### ğŸ“„ Pipeline Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PDF     â”‚â”€â”€â–ºâ”‚ PyMuPDF       â”‚â”€â”€â–ºâ”‚ NLTK       â”‚â”€â”€â–ºâ”‚ Clean &     â”‚â”€â”€â–ºâ”‚ Firebase     â”‚
â”‚ Files   â”‚   â”‚ Extract Text  â”‚   â”‚ Tokenize   â”‚   â”‚ Lemmatize   â”‚   â”‚ Save Index   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“š Document Sources
- 5 scientific PDFs about plant diseases from GitHub repository
- Organized as: D1, D2, D3, D4, D5

### ğŸ”¤ Text Processing Steps

1. **Extract**: `fitz.open()` â†’ get text per page
2. **Tokenize**: `word_tokenize()` splits text into words
3. **Normalize**: lowercase, remove special characters
4. **Filter Stop Words**:
   - Base: a, the, is, are, etc.
   - Academic noise: "et al", "figure", "methodology", etc.
5. **Remove Noise Tokens**:
   - Too long (>25 chars)
   - Too many digits (IDs, codes)
6. **Lemmatize**: `WordNetLemmatizer` â†’ root form (running â†’ run)

### ğŸ—ƒï¸ Inverted Index Structure
```python
{
    "bacterial": ["doc1.pdf#page=3", "doc2.pdf#page=7", ...],
    "tomato": ["doc1.pdf#page=5", "doc3.pdf#page=12", ...],
    ...
}
```
Each term maps to list of pages where it appears.

### âš¡ Optimization
- Index saved to Firebase once, reused on subsequent runs
- `check_index_exists_in_firebase()` prevents redundant processing
"""

def start_background_fetch():
  get_data_from_sensors(1)

# Auto-load 5 PDFs from GitHub

from pathlib import Path

#GitHub repo details
GITHUB_OWNER  = "Miron-Hanukaiev"
GITHUB_REPO   = "Introduction_to_Cloud_Computing"
GITHUB_BRANCH = "main"

PDF_FILENAMES = [
    "1-s2.0-S2772899424000417-main.pdf",
    "fpls_07_01419_pdf.pdf",
    "pdis-03-15-0340-fe.pdf",
    "s41598-024-52038-y.pdf",
    "s41598-025-98454-6.pdf"
]

RAW_BASE = f"https://raw.githubusercontent.com/{GITHUB_OWNER}/{GITHUB_REPO}/{GITHUB_BRANCH}"

# Download destination in Colab
LOCAL_PDF_DIR = Path("/content/pdfs")
LOCAL_PDF_DIR.mkdir(parents=True, exist_ok=True)

def download_pdf(url: str, out_path: Path):
    r = requests.get(url, stream=True, timeout=60)
    if r.status_code != 200:
        raise RuntimeError(f"Failed to download: {url} (status {r.status_code})")
    with open(out_path, "wb") as f:
        for chunk in r.iter_content(chunk_size=1024 * 1024):
            if chunk:
                f.write(chunk)

print("\nDownloading PDFs from GitHub...")
pdf_paths = []
for name in PDF_FILENAMES:
    url = f"{RAW_BASE}/{name}"
    out_path = LOCAL_PDF_DIR / name

    if not out_path.exists():
        print(" - downloading:", name)
        download_pdf(url, out_path)
    else:
        print(" - already exists:", name)

    pdf_paths.append(out_path)

print("\nPDFs ready:")
for i, p in enumerate(pdf_paths, 1):
    print(f"{i}. {p.name} ({p.stat().st_size} bytes)")

if len(pdf_paths) < 5:
    raise ValueError(f"Need at least 5 PDFs (found {len(pdf_paths)})")

# filename -> full path (helps build links in the UI)
FILEPATH_BY_NAME = {p.name: str(p) for p in pdf_paths}

# Re-define the link builder to point to the Cloud (GitHub Raw)

RAW_URL_BASE = f"https://raw.githubusercontent.com/{GITHUB_OWNER}/{GITHUB_REPO}/{GITHUB_BRANCH}"

def build_pdf_link(filename: str, page: int) -> str:
    """
    Generates a direct link to the PDF on GitHub.
    Browsers (Chrome/Edge) support '#page=X' on raw PDF URLs.
    """
    # Safe encoding for URL
    safe_filename = urllib.parse.quote(filename)
    return f"{RAW_URL_BASE}/{safe_filename}#page={page}"

def extract_pages_from_pdf(pdf_path: str):
    # Extract text per page (page number starts from 1)
    doc = fitz.open(pdf_path)
    pages = []
    for page_idx in range(len(doc)):
        text = doc.load_page(page_idx).get_text("text")
        text = re.sub(r"\s+", " ", text).strip()
        pages.append((page_idx + 1, text))
    doc.close()
    return pages

# Build docs: one record per page
docs = []
doc_map = {}  # D1..D5 -> filename (for the report)

print("\nProcessing files...")
for i, pdf_path in enumerate(pdf_paths, 1):
    doc_id = f"D{i}"
    doc_map[doc_id] = pdf_path.name

    for page_num, page_text in extract_pages_from_pdf(str(pdf_path)):
        if page_text:  # skip empty pages
            docs.append({
                "doc_id": doc_id,
                "filename": pdf_path.name,
                "page": page_num,
                "text": page_text
            })

print(f"Done! Total pages loaded (all docs): {len(docs)}")

print("\nDocID mapping (for the report):")
for k, v in doc_map.items():
    print(f"{k} -> {v}")

if not docs:
    raise ValueError("No text pages were extracted from the PDFs (maybe scanned PDFs with no text).")

# NLTK resources (Colab sometimes needs downloads)
nltk.download("punkt", quiet=True)
nltk.download("punkt_tab", quiet=True)  # helps on some NLTK versions
nltk.download("wordnet", quiet=True)
nltk.download("omw-1.4", quiet=True)

from nltk.tokenize import word_tokenize
from nltk.stem import WordNetLemmatizer

lemmatizer = WordNetLemmatizer()
USE_LEMMATIZATION = True  # we can flip this if needed

# Basic stopwords + "paper noise" words
BASE_STOPWORDS = set("""
a an the and or but if while with without within by for from to of in on at as is are was were be been being
this that these those it its they them their we our you your i he she his her
can could may might should would will do does did done
""".split())

ACADEMIC_NOISE = set("""
et al fig figure table tables eq equation equations
introduction related works methodology methods results discussion conclusion
study studies paper papers dataset data approach approaches proposed based using used
analysis model models algorithm algorithms performance evaluation
""".split())

STOP_WORDS_SET = BASE_STOPWORDS | ACADEMIC_NOISE

print("STOP_WORDS count:", len(STOP_WORDS_SET))
print("Lemmatization enabled:", USE_LEMMATIZATION)

def normalize_token(token: str) -> str:
    # lower + keep only a-z / 0-9 / hyphen (e.g., resnet50, resnet-50)
    token = token.lower()
    token = re.sub(r"[^a-z0-9\-]", "", token)
    return token

def is_noise_token(tok: str) -> bool:
    # too long
    if len(tok) > 25:
        return True

    # tokens with lots of digits are usually IDs (e.g., 101007s11263-...)
    digits = sum(ch.isdigit() for ch in tok)
    if digits >= 6:
        return True

    # tokens with both letters+digits and very long are usually codes
    has_alpha = any(ch.isalpha() for ch in tok)
    has_digit = any(ch.isdigit() for ch in tok)
    if has_alpha and has_digit and len(tok) > 12:
        return True

    # mostly digits is not helpful for semantic search
    if tok.isdigit() and len(tok) >= 4:
        return True

    return False

def tokenize_and_clean(text: str):
    # tokenize -> normalize -> filter -> optional lemmatize
    tokens = word_tokenize(text)
    cleaned = []

    for tok in tokens:
        tok = normalize_token(tok)

        if not tok:
            continue
        if tok in STOP_WORDS_SET:
            continue
        if len(tok) < 3:
            continue
        if is_noise_token(tok):
            continue

        if USE_LEMMATIZATION:
            tok = lemmatizer.lemmatize(tok)

        cleaned.append(tok)

    return cleaned

def to_tfidf_text(text: str) -> str:
    # TF-IDF expects a string, so we join cleaned tokens with spaces
    return " ".join(tokenize_and_clean(text or ""))

def make_page_link(doc_id: str, filename: str, page: int) -> str:
    # simple reference we can show in results
    return f"{filename}#page={page} ({doc_id})"

# Build inverted index: term -> pages
inverted_index = defaultdict(set)

for d in docs:
    page_ref = make_page_link(d["doc_id"], d["filename"], d["page"])

    # set() so we don't add the same term twice for the same page
    terms = set(tokenize_and_clean(d["text"]))

    for term in terms:
        inverted_index[term].add(page_ref)

# convert sets to sorted lists (nice and stable output)
inverted_index = {term: sorted(list(pages)) for term, pages in inverted_index.items()}

print("Inverted index built. Terms:", len(inverted_index))

index_records = [
    {"term": term, "DocIDs": docids}
    for term, docids in sorted(inverted_index.items())
]

# FLAG: Check if index already exists in Firebase before saving
if check_index_exists_in_firebase():
    print("âœ… Index already exists in Firebase - skipping save (faster load!)")
    print("   To force re-index, delete /index from Firebase first.")
else:
    print("ğŸ“ Index not found in Firebase - saving now...")
    FBconn.delete("/", "index")
    save_index_records_to_firebase(index_records)
    print("âœ… Index saved to Firebase at /index")

print("âœ… Sample from Firebase:", load_index_records_from_firebase(3))

print("\nSample index records (term + DocIDs):")
for r in index_records[:10]:
    print(r["term"], "->", len(r["DocIDs"]), "links")

# table for report
pd.DataFrame(index_records).head(10)

"""---
# 5. Search Engine & AI Features <a id="search-engine"></a>

### ğŸ” Hybrid Search Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER QUERY                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: RETRIEVAL (Firebase Cloud)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ Tokenize & clean query                                            â”‚
â”‚  â€¢ For each term, fetch DocIDs from /index/{term}                   â”‚
â”‚  â€¢ Union all results â†’ Candidate documents                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: RANKING (Local TF-IDF)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ Build TfidfVectorizer on candidates only                         â”‚
â”‚  â€¢ Transform query to vector                                         â”‚
â”‚  â€¢ Calculate Cosine Similarity: sim = (QÂ·D)/(|Q|Ã—|D|)               â”‚
â”‚  â€¢ Sort by score descending                                          â”‚
â”‚  â€¢ Filter out score < 0.01                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESULTS: Ranked documents with relevance scores                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ TF-IDF Formula
```
TF(t,d) = frequency of term t in document d
IDF(t) = log(N / df(t))  where N = total docs, df = docs containing t
TF-IDF(t,d) = TF Ã— IDF
```

### ğŸ§  Plant Disease Detection (AI)

| Component | Details |
|-----------|---------|
| **Model** | MobileNetV2 from Hugging Face |
| **Task** | Image Classification |
| **Input** | Plant image (any format) |
| **Output** | Top 5 predictions with confidence % |
| **Advice** | Custom recommendations per disease type |

### ğŸ¯ Disease Advice Database
- 20+ disease types with specific treatment recommendations
- Color-coded status: Green (healthy), Yellow (warning), Red (urgent)

"""

# PLANT DISEASE DETECTION - Hugging Face

# Initialize the plant disease classifier
# Using a plant disease detection model from Hugging Face
plant_classifier = None

def initialize_plant_classifier():
    """Initialize the plant disease classifier (lazy loading)."""
    global plant_classifier
    if plant_classifier is None:
        try:
            # Option 1: General plant disease model
            plant_classifier = pipeline(
                "image-classification",
                model="linkanjarad/mobilenet_v2_1.0_224-plant-disease-identification"
            )
        except Exception as e:
            print(f"âš ï¸ Could not load plant model, trying backup...")
            try:
                # Option 2: Backup - general image classifier
                plant_classifier = pipeline(
                    "image-classification",
                    model="google/vit-base-patch16-224"
                )
                print("âœ… Backup model loaded!")
            except Exception as e2:
                print(f"âŒ Error loading model: {e2}")
                plant_classifier = None
    return plant_classifier

def analyze_plant_image(image_bytes):
    """
    Analyze a plant image for diseases.

    Args:
        image_bytes: Raw bytes of the image

    Returns:
        dict with analysis results
    """
    try:
        classifier = initialize_plant_classifier()
        add_reward(5, 5)
        if classifier is None:
            return {
                "success": False,
                "error": "Model not available",
                "results": []
            }

        # Convert bytes to PIL Image
        image = PILImage.open(io.BytesIO(image_bytes))

        # Ensure RGB mode
        if image.mode != 'RGB':
            image = image.convert('RGB')

        # Run classification
        results = classifier(image)

        # Process results
        processed_results = []
        for r in results[:5]:  # Top 5 results
            label = r['label']
            score = r['score']

            # Clean up label
            clean_label = label.replace('_', ' ').title()

            processed_results.append({
                "label": clean_label,
                "confidence": round(score * 100, 1),
                "raw_label": label
            })

        return {
            "success": True,
            "results": processed_results,
            "top_prediction": processed_results[0] if processed_results else None
        }

    except Exception as e:
        return {
            "success": False,
            "error": str(e),
            "results": []
        }

def get_disease_advice(disease_label):
    """Get care advice based on detected disease."""

    label_lower = disease_label.lower()

    advice_db = {
        "healthy": {
            "status": "âœ… Healthy Plant",
            "color": "#2C5F4B",
            "advice": "Your plant looks healthy! Continue your current care routine. Water when soil is dry and ensure adequate sunlight."
        },
        "bacterial": {
            "status": "âš ï¸ Bacterial Infection",
            "color": "#D9534F",
            "advice": "Remove affected leaves immediately. Avoid overhead watering. Apply copper-based bactericide. Improve air circulation around the plant."
        },
        "spot": {
            "status": "âš ï¸ Leaf Spot Disease",
            "color": "#F0AD4E",
            "advice": "Remove and destroy infected leaves. Avoid wetting foliage when watering. Apply fungicide if spreading. Ensure good air circulation."
        },
        "rust": {
            "status": "ğŸ”´ Rust Disease",
            "color": "#D9534F",
            "advice": "Remove all infected leaves immediately. Apply fungicide spray. Avoid overhead watering. Don't compost infected material."
        },
        "blight": {
            "status": "ğŸ”´ Blight Detected",
            "color": "#D9534F",
            "advice": "Act fast! Remove all infected parts. Apply copper fungicide. Improve drainage and air flow. Consider removing severely affected plants."
        },
        "mildew": {
            "status": "âš ï¸ Mildew Found",
            "color": "#F0AD4E",
            "advice": "Improve air circulation. Reduce humidity around plant. Apply neem oil or fungicide. Water at base, not on leaves."
        },
        "powdery": {
            "status": "âš ï¸ Powdery Mildew",
            "color": "#F0AD4E",
            "advice": "Spray with mixture of water and baking soda. Improve air circulation. Remove heavily infected leaves. Apply fungicide if severe."
        },
        "wilt": {
            "status": "âš ï¸ Wilting Issue",
            "color": "#F0AD4E",
            "advice": "Check soil moisture - could be over or under watering. Inspect roots for rot. Ensure proper drainage. Move to shadier spot if heat stressed."
        },
        "yellow": {
            "status": "âš ï¸ Yellowing Leaves",
            "color": "#F0AD4E",
            "advice": "Check watering schedule - often caused by overwatering. Test soil nutrients. Ensure adequate light. Check for pests underneath leaves."
        },
        "mosaic": {
            "status": "ğŸ”´ Mosaic Virus",
            "color": "#D9534F",
            "advice": "No cure exists. Remove and destroy infected plants. Control aphids that spread it. Disinfect tools. Don't plant in same spot."
        },
        "scab": {
            "status": "âš ï¸ Scab Disease",
            "color": "#F0AD4E",
            "advice": "Remove fallen leaves. Apply fungicide in early spring. Improve air circulation. Choose resistant varieties for future planting."
        },
        "pepper": {
            "status": "ğŸŒ¶ï¸ Pepper Plant Issue",
            "color": "#F0AD4E",
            "advice": "For bacterial spot: remove affected leaves, avoid overhead watering, apply copper spray. Ensure 6-8 hours of sunlight daily."
        },
        "tomato": {
            "status": "ğŸ… Tomato Plant Issue",
            "color": "#F0AD4E",
            "advice": "Remove affected lower leaves. Stake plants for airflow. Water at soil level, not leaves. Apply appropriate fungicide if needed."
        },
        "apple": {
            "status": "ğŸ Apple Tree Issue",
            "color": "#F0AD4E",
            "advice": "Prune affected branches. Apply dormant spray in winter. Remove fallen leaves. Ensure good air circulation between branches."
        },
        "grape": {
            "status": "ğŸ‡ Grape Vine Issue",
            "color": "#F0AD4E",
            "advice": "Improve air circulation through pruning. Apply fungicide early in season. Remove infected leaves. Avoid overhead irrigation."
        },
        "corn": {
            "status": "ğŸŒ½ Corn Plant Issue",
            "color": "#F0AD4E",
            "advice": "Ensure proper spacing for airflow. Rotate crops yearly. Remove infected plant debris. Use disease-resistant seed varieties."
        },
        "potato": {
            "status": "ğŸ¥” Potato Plant Issue",
            "color": "#F0AD4E",
            "advice": "Remove infected plants immediately. Don't compost diseased material. Rotate crops for 3+ years. Avoid overhead watering."
        },
        "strawberry": {
            "status": "ğŸ“ Strawberry Plant Issue",
            "color": "#F0AD4E",
            "advice": "Remove infected leaves and fruits. Improve air circulation. Apply fungicide if needed. Mulch to prevent soil splash on leaves."
        },
        "cherry": {
            "status": "ğŸ’ Cherry Tree Issue",
            "color": "#F0AD4E",
            "advice": "Prune to improve airflow. Apply fungicide during wet periods. Remove fallen leaves. Avoid wetting foliage when watering."
        },
        "peach": {
            "status": "ğŸ‘ Peach Tree Issue",
            "color": "#F0AD4E",
            "advice": "Apply dormant spray in late winter. Remove infected twigs. Ensure good drainage. Prune for open canopy and airflow."
        }
    }

    # Search for matching advice - check multiple keywords
    for key, value in advice_db.items():
        if key in label_lower:
            return value

    # If no specific match, give general advice based on whether it seems healthy or diseased
    if "healthy" in label_lower:
        return advice_db["healthy"]

    # General disease advice
    return {
        "status": "ğŸ” Condition Detected",
        "color": "#0B5ED7",
        "advice": "Based on the analysis, your plant may need attention. Remove any visibly damaged leaves, ensure proper watering, and monitor for changes. Consider consulting a local garden center for specific treatment options."
    }

# Search Engine (TF-IDF) + Simple Search Screen (widgets)

#Build TF-IDF vectors for all pages
page_texts_raw = [d["text"] for d in docs]
page_texts_clean = [to_tfidf_text(t) for t in page_texts_raw]

vectorizer = TfidfVectorizer(max_features=50000, ngram_range=(1, 2))
X = vectorizer.fit_transform(page_texts_clean)

# Keep metadata aligned with X rows (same index)
page_meta = [{
    "doc_id": d["doc_id"],
    "filename": d["filename"],
    "page": d["page"],
} for d in docs]

def _short_snippet(text: str, max_len: int = 150):
    # short preview for the table
    text = re.sub(r"\s+", " ", text).strip()
    return text[:max_len] + "..." if len(text) > max_len else text

def search_pages(query: str, top_k: int = 5):
    """
    Hybrid Search:
    1. Retrieves candidate DocIDs from Firebase (Cloud Index).
    2. Ranks them using TF-IDF (Local Processing) for better accuracy.
    """

    # Get relevant DocIDs from Firebase
    query_terms = tokenize_and_clean(query)
    if not query_terms:
        return []

    # Set to store unique document references found in Firebase
    found_refs = set()

    for term in query_terms:
        # Fetch DocIDs from Firebase
        record = FBconn.get(f"{INDEX_PATH}/{term}", None)
        if record and 'DocIDs' in record:
            # Add all docs containing this term to our candidate list
            for ref in record['DocIDs']:
                found_refs.add(ref)

    # If Firebase returned no documents, stop here
    if not found_refs:
        return []

    # Prepare data for TF-IDF Ranking

    # Create a mapping to easily find document content by its reference string
    lookup_map = {}
    for d in docs:
        key = make_page_link(d['doc_id'], d['filename'], d['page'])
        lookup_map[key] = d

    candidate_docs = []
    candidate_refs = []

    for ref in found_refs:
        original_doc = lookup_map.get(ref)
        if original_doc:
            candidate_docs.append(original_doc)
            candidate_refs.append(ref)

    # Run TF-IDF on the candidates

    # Prepare text for the candidates
    candidate_texts = [to_tfidf_text(d["text"]) for d in candidate_docs]
    query_clean = to_tfidf_text(query)

    # Fit vectorizer ONLY on these candidates (Dynamic TF-IDF)
    temp_vectorizer = TfidfVectorizer(max_features=5000, ngram_range=(1, 2))

    try:
        # Create the matrix for candidates
        tfidf_matrix = temp_vectorizer.fit_transform(candidate_texts)
        # Transform the query
        query_vec = temp_vectorizer.transform([query_clean])

        # Calculate Cosine Similarity
        sims = cosine_similarity(query_vec, tfidf_matrix)[0]

        # Sort results
        sorted_indices = np.argsort(sims)[::-1][:top_k]

        results = []
        rank = 1

        for idx in sorted_indices:
            score = float(sims[idx])

            # Filter out very low relevance
            if score < 0.01:
                continue

            doc_data = candidate_docs[idx]

            results.append({
                "rank": rank,
                "score": round(score, 4),
                "doc_id": doc_data["doc_id"],
                "filename": doc_data["filename"],
                "page": doc_data["page"],
                "snippet_full": (doc_data["text"] or "").strip(),
                "snippet_table": _short_snippet(doc_data["text"] or "")
            })
            rank += 1

        return results

    except ValueError:
        # Fallback if TF-IDF fails (e.g., empty vocabulary overlap)
        return []



def generate_answer_extract(results):

    if not results:
        return "No relevant information found."

    sentences = []
    for r in results[:3]:
        text = r["snippet_full"][:800]
        parts = re.split(r"(?<=[.!?])\s+", text)

        for s in parts:
            s = s.strip()
            if len(s) > 40:
                sentences.append(s)
            if len(sentences) >= 4:
                break

        if len(sentences) >= 4:
            break

    return " ".join(sentences)

"""---
# 6. Search Screen UI <a id="search-ui"></a>

### ğŸ–¥ï¸ UI Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Plant Knowledge Base                                             â”‚
â”‚  Search our library for care guides and diagnosis                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [________________________Search Query________________________] [ğŸ”] â”‚
â”‚                                                                      â”‚
â”‚  Results: [Slider 1-10]                                              â”‚
â”‚                                                                      â”‚
â”‚  Popular: [tomato] [bacterial] [disease] [leaf spot] [treatment]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ¨ AI GENERATED SUMMARY                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Extracted sentences from top results...                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“„ Results                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [Filename] [Page X] [High/Medium/Low relevance]             â”‚    â”‚
â”‚  â”‚ Title â†’ Link to PDF                                          â”‚    â”‚
â”‚  â”‚ ...snippet preview...                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¨ Features
- **Popular Tags**: Quick search buttons for common terms
- **AI Summary**: Auto-generated extract from top results
- **Relevance Badges**: Visual indicator (High/Medium/Low)
- **Direct Links**: Opens PDF at specific page
- **Loading Animation**: Spinner while searching
- **Gamification**: +5 XP, +2 Coins per search

"""

def search_screen():
    """RAG Search Screen - ×©×•××œ ××ª ×”-LLM ×•××§×‘×œ ×ª×©×•×‘×” ×××™×ª×™×ª"""

    display(HTML("""
    <style>
        .rag-container { background: white; padding: 30px; border-radius: 20px; width: 900px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .rag-answer-card { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); padding: 25px; border-radius: 15px; border-left: 6px solid #2C5F4B; margin: 20px 0; max-width: 850px; }
        .rag-source-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px; max-width: 850px; }
        .rag-source-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .tag-btn { background: #E3F4E0 !important; color: #2C5F4B !important; border: none !important; border-radius: 15px !important; font-size: 12px !important; padding: 5px 15px !important; margin: 3px !important; }
        .tag-btn:hover { background: #2C5F4B !important; color: white !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-pulse { animation: pulse 1.5s infinite; }
    </style>
    """))

    title_html = widgets.HTML("""
        <div style='text-align:center; margin-bottom: 20px;'>
            <div style='width: 60px; height: 60px; background: linear-gradient(135deg, #E3F4E0, #C8E6C9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 28px;'>ğŸ”</div>
            <h2 style='color:#2C5F4B; margin: 0;'>Plant Knowledge Base <span style='background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; font-size: 10px; padding: 3px 8px; border-radius: 10px; margin-left: 8px;'>RAG + AI</span></h2>
            <p style='color:#888; font-size:14px; margin-top:8px;'>Ask questions and get AI-powered answers from scientific papers</p>
        </div>
    """)

    query_input = widgets.Text(placeholder="Ask about plant diseases, treatments...", layout=widgets.Layout(width='550px', height='45px'))
    k_slider = widgets.IntSlider(value=5, min=1, max=10, description='', layout=widgets.Layout(width='150px'))
    slider_label = widgets.HTML("<span style='color: #666; font-size: 13px;'>Sources:</span>")
    search_btn = widgets.Button(description="ğŸ” Ask AI", button_style='success', layout=widgets.Layout(width='120px', height='45px'))

    answer_out = widgets.Output()
    sources_out = widgets.Output()

    popular_terms = ['bacterial leaf spot', 'tomato disease', 'plant virus', 'fungal treatment', 'disease symptoms']

    def make_tag_handler(term):
        def handler(btn):
            query_input.value = term
            on_search(None)
        return handler

    tag_buttons = []
    for term in popular_terms:
        btn = widgets.Button(description=term, layout=widgets.Layout(height='30px', width='auto'))
        btn.add_class('tag-btn')
        btn.on_click(make_tag_handler(term))
        tag_buttons.append(btn)

    popular_row = widgets.HBox([widgets.HTML("<span style='color:#999;font-size:12px;margin-right:5px;'>Try:</span>")] + tag_buttons, layout=widgets.Layout(align_items='center', justify_content='center', margin='15px 0'))

    def on_search(_):
        query = (query_input.value or "").strip()
        answer_out.clear_output()
        sources_out.clear_output()

        if not query:
            with answer_out:
                display(HTML("<div style='background:#FFF3CD;color:#856404;padding:15px;border-radius:10px;text-align:center;margin-top:20px;'>âš ï¸ Please enter a question</div>"))
            return

        with answer_out:
            display(HTML("<div style='text-align:center;padding:40px;'><div style='font-size:40px;' class='loading-pulse'>ğŸŒ±</div><p>Searching & generating AI answer...</p></div>"))

        result = rag_engine.search_and_generate(query, top_k=k_slider.value)
        answer_out.clear_output()
        sources_out.clear_output()

        if result["success"] and result["sources"]:
            add_reward(5, 2)

        with answer_out:
            if result["success"]:
                formatted = result["answer"].replace('\n', '<br>')
                formatted = re.sub(r'\*\*(.*?)\*\*', r'<strong>\1</strong>', formatted)
                display(HTML(f"""
                    <div class='rag-answer-card'>
                        <div style='margin-bottom:15px;'><span style='background:#E8F5E9;color:#2E7D32;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;'>ğŸ¤– AI Answer (RAG)</span>
                        <span style='color:#666;font-size:12px;margin-left:10px;'>Based on {len(result["sources"])} source(s)</span></div>
                        <div style='color:#333;font-size:15px;line-height:1.7;'>{formatted}</div>
                    </div>
                """))
            else:
                display(HTML(f"<div style='background:#FFEBEE;padding:20px;border-radius:15px;text-align:center;'><div style='font-size:35px;'>ğŸ˜•</div><p style='color:#C62828;'>Error occurred</p></div>"))

        with sources_out:
            if result["sources"]:
                display(HTML(f"<div style='margin:20px 0 15px;'><h3 style='color:#2C5F4B;margin:0;font-size:16px;'>ğŸ“š Sources ({len(result['sources'])})</h3></div>"))
                for i, src in enumerate(result["sources"]):
                    link = build_pdf_link(src["filename"], src["page"])
                    display(HTML(f"""
                        <div class='rag-source-card'>
                            <span style='background:#E3F2FD;color:#1565C0;padding:4px 10px;border-radius:12px;font-size:11px;'>Source {i+1}</span>
                            <a href='{link}' target='_blank' style='color:#1565C0;text-decoration:none;font-weight:600;margin-left:10px;'>{src["filename"]} - Page {src["page"]} â†—</a>
                            <p style='color:#666;font-size:13px;margin:10px 0 0;'>...{html.escape(src["snippet"][:150])}...</p>
                        </div>
                    """))

    search_btn.on_click(on_search)
    try:
        query_input.on_submit(on_search)
    except:
        pass

    search_row = widgets.HBox([query_input, search_btn], layout=widgets.Layout(align_items='center', justify_content='center', margin='10px 0'))
    slider_row = widgets.HBox([slider_label, k_slider], layout=widgets.Layout(align_items='center', justify_content='center'))
    search_card = widgets.VBox([title_html, search_row, slider_row, popular_row])
    search_card.add_class("rag-container")

    return widgets.VBox([search_card, answer_out, sources_out], layout=widgets.Layout(align_items='center', padding='20px'))

"""---
# 7. Upload Functions & Home Screen Helpers <a id="upload-helpers"></a>

### ğŸ“¤ Upload System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User selects   â”‚ â”€â”€â–º â”‚ Convert to     â”‚ â”€â”€â–º â”‚ Save to        â”‚
â”‚ image file     â”‚     â”‚ Base64         â”‚     â”‚ Firebase       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚ Return unique  â”‚
                                              â”‚ upload ID      â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”§ Upload Functions

| Function | Purpose |
|----------|---------|
| `save_uploaded_file_to_firebase()` | Store image with metadata |
| `get_upload_history_from_firebase()` | Retrieve all uploads |
| `delete_file_from_firebase()` | Remove upload by ID |

### ğŸ“‹ Stored Data Structure
```python
{
    "filename": "plant_photo.jpg",
    "timestamp": "2025-01-09 14:30:00",
    "content_b64": "base64_encoded_image_data..."
}
```

### ğŸ  Home Screen Helpers
- Sensor status display
- Recent activity summary
- Quick action buttons

"""

# Upload History Functions

UPLOAD_PATH = '/plant_uploads'

def save_uploaded_file_to_firebase(filename, file_data):
    """Saves a single file's data (Base64) to Firebase."""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    # Store only essential metadata and the base64 content
    data_to_save = {
        "filename": filename,
        "timestamp": timestamp,
        "content_b64": file_data['content_b64'] # Base64 encoded content
    }
    # Firebase generates a unique push ID
    result = FBconn.post(UPLOAD_PATH, data_to_save)
    return result

def get_upload_history_from_firebase():
    """Retrieves all file upload history from Firebase."""
    data = FBconn.get(UPLOAD_PATH, None)
    if data:
        # Convert the Firebase dictionary of items into a list of items
        # where the key is the file ID (for deletion)
        history = [
            {"id": key, **value} for key, value in data.items()
        ]
        # Sort by timestamp, newest first
        history.sort(key=lambda x: x['timestamp'], reverse=True)
        return history
    return []

def delete_file_from_firebase(file_id):
    """Deletes a file entry from Firebase using its ID."""
    FBconn.delete(UPLOAD_PATH, file_id)
    print(f"File ID {file_id} deleted successfully.")

#return a random tip for tip cell in home page
def get_a_tip():
  tips = [
        "Check soil moisture before watering. Sticking your finger 1 inch deep is the best test.",
        "Most houseplants prefer bright, indirect light rather than direct sun.",
        "Don't forget to dust your plant's leaves so they can photosynthesize efficiently.",
        "Ensure your pots have drainage holes to prevent root rot.",
        "Rotate your plants occasionally to ensure even growth on all sides.",
        "Yellow leaves are often a sign of overwatering, not underwatering.",
        "Group tropical plants together to increase local humidity.",
        "Use room temperature water to avoid shocking the plant's roots.",
        "Check the top inch of soil before watering. If it's damp, wait another day."
    ]
  return random.choice(tips)

# count how many times the soil condition improved or declined relative to the optimal level and calculates the average moisture value.
def get_weekly_highlights():
    """
    Calculate REAL weekly highlights from sensor data.
    """
    try:
        soil_data = get_sensor_history_from_firebase("soil", 60)

        if len(soil_data) < 2:
            return {"improved": 0, "declined": 0, "avg_growth": "N/A"}

        improved = 0
        declined = 0

        for i in range(len(soil_data) - 1):
            current = float(soil_data[i].get("value", 0))
            previous = float(soil_data[i + 1].get("value", 0))

            optimal_mid = 50
            current_diff = abs(current - optimal_mid)
            previous_diff = abs(previous - optimal_mid)

            if current_diff < previous_diff:
                improved += 1
            elif current_diff > previous_diff:
                declined += 1

        # Calculate average change
        total_readings = len(soil_data)
        if total_readings > 0:
            values = [float(d.get("value", 0)) for d in soil_data]
            avg_val = sum(values) / len(values)
            avg_growth = f"{int(avg_val)}%"
        else:
            avg_growth = "N/A"

        return {
            "improved": improved,
            "declined": declined,
            "avg_growth": avg_growth
        }
    except Exception as e:
        print(f"Error calculating highlights: {e}")
        return {"improved": 0, "declined": 0, "avg_growth": "N/A"}


def get_plants_needing_water():
    """
    Calculate how many readings indicate dry soil (needs watering).
    Returns count of recent dry readings.
    """
    try:
        soil_data = get_sensor_history_from_firebase("soil", 10)

        if not soil_data:
            return 0

        # Count readings below 30% (dry)
        dry_count = sum(1 for d in soil_data if float(d.get("value", 50)) < 30)
        return dry_count
    except:
        return 0

  # Plant Status Function
def get_plant_status():
    """Get current plant status based on latest soil reading."""
    data_list = get_sensor_history_from_firebase("soil", 1)
    if not data_list:
        return "Unknown â“", "#E0E0E0", "No data"
    value = float(data_list[0]["value"])
    if value < 30:
        return "Needs Water ğŸ’§", "#F8D7DA", "Soil is dry"
    elif value <= 70:
        return "Healthy ğŸŒ±", "#D4EDDA", "Soil is perfect"
    else:
        return "Too Wet âš ï¸", "#FFF3CD", "Soil is wet"

"""---
# 8. Home Screen (Dashboard)

The main dashboard shows:
- Current sensor readings (temp, humidity, soil) with status colors
- Recent activity
- Quick action buttons to navigate to other screens

### ğŸ¨ Design Elements
- **Color coding**: Green (good), Yellow (warning), Red (alert)
- **Real-time data**: Pulls latest sensor readings from Firebase
- **Responsive cards**: Hover effects, shadows, rounded corners

"""

def home_screen():

    # Global Styles with Active Tab Support
    display(HTML("""
    <style>
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1) !important;
            cursor: pointer;
        }
        .action-btn { transition: all 0.3s; }
        .action-btn:hover { filter: brightness(95%); }

        /* Clickable card indicator */
        .clickable-card {
            cursor: pointer;
            position: relative;
        }
        .clickable-card::after {
            content: 'â†’';
            position: absolute;
            bottom: 10px;
            right: 15px;
            color: #2C5F4B;
            opacity: 0.5;
            font-size: 18px;
            transition: opacity 0.3s;
        }
        .clickable-card:hover::after {
            opacity: 1;
        }

        /* Info tooltip */
        .info-badge {
            background: #2C5F4B;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse 1.5s infinite; }
    </style>
    """))

    # Shared card style
    card_style = """
        background: #E3F4E0;
        width: 480px;
        height: 240px;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    """

    # 1. Upload Card (unchanged - already good)
    upload_html = widgets.HTML(
        """
        <div style='text-align:center;'>
            <div style='background: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto;'>
                <span style='font-size: 30px;'>ğŸ“·</span>
            </div>
            <h3 style='color:#2C5F4B; margin: 0 0 10px 0; font-family: sans-serif;'>Check Plant Health</h3>
            <p style='color:#555; font-size: 13px; margin: 0 0 15px 0;'>Upload a photo to detect diseases</p>
        </div>
        """
    )

    upload_btn = widgets.Button(
        description="Upload Photo",
        button_style='success',
        layout=widgets.Layout(width='180px', height='40px')
    )
    upload_btn.add_class("action-btn")
    upload_btn.on_click(lambda b: show_in_container(upload_screen))

    upload_card = widgets.VBox([upload_html, upload_btn])
    upload_card.add_class("hover-card")

    # 2. Weekly Highlights Card - NOW WITH REAL DATA
    highlights_output = widgets.Output()

    def load_highlights():
        with highlights_output:
            highlights_output.clear_output()
            # Show loading state first
            display(HTML("""
                <div style='width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;'>
                    <h3 style='color:#2C5F4B; text-align:center; margin-bottom: 20px;'>Weekly Highlights</h3>
                    <p style='text-align:center; color:#888;' class='loading'>Loading data...</p>
                </div>
            """))

        # Fetch real data
        stats = get_weekly_highlights()

        with highlights_output:
            highlights_output.clear_output()
            display(HTML(f"""
                <div style='width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;'>
                    <h3 style='color:#2C5F4B; text-align:center; margin-bottom: 20px;'>
                        Weekly Highlights
                        <span class='info-badge' title='Based on soil sensor readings'>LIVE</span>
                    </h3>
                    <div style='display: flex; justify-content: space-around; width: 100%; text-align: center;'>
                        <div style='border-right: 1px solid #ccc; width: 33%;'>
                            <div style='font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;'>Improved</div>
                            <div style='font-size: 32px; color: #2C5F4B; font-weight: bold;'>{stats['improved']}</div>
                        </div>
                        <div style='border-right: 1px solid #ccc; width: 33%;'>
                            <div style='font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;'>Declined</div>
                            <div style='font-size: 32px; color: #D9534F; font-weight: bold;'>{stats['declined']}</div>
                        </div>
                        <div style='width: 33%;'>
                            <div style='font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px;'>Avg Moisture</div>
                            <div style='font-size: 32px; color: #2C5F4B; font-weight: bold;'>{stats['avg_growth']}</div>
                        </div>
                    </div>
                </div>
            """))

    # Load data in background
    load_highlights()

    highlights_box = widgets.VBox([highlights_output])
    highlights_box.add_class("hover-card")
    # Make it clickable - goes to Soil screen for details
    highlights_box.on_click = lambda: show_in_container(soil_screen)

    # 3. Daily Tip Card
    tip_str = get_a_tip()
    tip_html = widgets.HTML(
        f"""
        <div style='text-align:center; padding: 20px;'>
            <div style='font-size: 24px; margin-bottom: 10px;'>ğŸ’¡</div>
            <h3 style='color:#2C5F4B; margin: 0 0 10px 0;'>Daily Tip</h3>
            <p style='font-size: 14px; line-height: 1.5; color: #444; margin: 0;'>
                "{tip_str}"
            </p>
        </div>
        """
    )
    tip_box = widgets.VBox([tip_html])
    tip_box.add_class("hover-card")

    # 4. Watering Alert Card
    water_count = get_plants_needing_water()

    # Dynamic color based on urgency
    if water_count == 0:
        water_color = "#2C5F4B"
        water_bg = "#D4EDDA"
        water_text = "All good!"
        water_icon = "âœ…"
    elif water_count < 3:
        water_color = "#0B5ED7"
        water_bg = "#CFE2FF"
        water_text = "Check soon"
        water_icon = "ğŸ’§"
    else:
        water_color = "#D9534F"
        water_bg = "#F8D7DA"
        water_text = "Needs attention!"
        water_icon = "âš ï¸"

    water_html = widgets.HTML(
        f"""
        <div style='text-align:center;'>
            <h3 style='color:#2C5F4B; margin: 0 0 10px 0;'>Watering Status</h3>
            <div style='font-size: 48px; color: {water_color}; font-weight: bold; margin: 10px 0;'>{water_count}</div>
            <div style='background: {water_bg}; color: {water_color}; padding: 5px 15px; border-radius: 15px; font-size: 12px; display: inline-block;'>
                {water_icon} {water_text}
            </div>
            <p style='font-size: 11px; color: #888; margin-top: 10px;'>Dry readings in last 10 samples</p>
        </div>
        """
    )
    water_box = widgets.VBox([water_html])
    water_box.add_class("hover-card")

    # 5. Status Footer
    status, bg_color, desc = get_plant_status()
    text_color = "#333"

    status_card_html = widgets.HTML(f"""
    <div style="
        background:{bg_color};
        width: 800px;
        padding: 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-left: 40px; padding-right: 40px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-top: 20px;
        cursor: pointer;
        transition: transform 0.2s;
    " onclick="this.style.transform='scale(0.98)'; setTimeout(()=>this.style.transform='scale(1)', 100);"
       title="Click to view detailed soil data">
        <div style='display:flex; align-items:center;'>
            <span style='font-size: 30px; margin-right: 15px;'>ğŸŒ±</span>
            <div>
                <h3 style="margin:0; color:{text_color}; font-size: 18px;">Overall Soil Status</h3>
                <p style="margin:0; color:{text_color}; opacity: 0.8; font-size: 14px;">Latest sensor reading</p>
            </div>
        </div>

        <div style='text-align:right;'>
            <h2 style="margin:0; color:{text_color}; font-weight:700;">{status}</h2>
            <small style="color:{text_color};">{desc}</small>
        </div>
    </div>
    """)

    # Apply style to boxes
    for box in [upload_card, highlights_box, tip_box, water_box]:
        box.layout = widgets.Layout(
            width='450px',
            height='220px',
            margin='10px',
            align_items='center',
            justify_content='center'
        )
        box.add_class("card-style")

    # Inject the actual CSS for the cards
    display(HTML(f"""
    <style>
        .card-style {{
            {card_style}
        }}
    </style>
    """))

    # Layout: Organize in rows
    row1 = widgets.HBox([upload_card, highlights_box], layout=widgets.Layout(justify_content='center'))
    row2 = widgets.HBox([tip_box, water_box], layout=widgets.Layout(justify_content='center'))

    return widgets.VBox(
        [row1, row2, status_card_html],
        layout=widgets.Layout(align_items='center', padding='20px')
    )


# NAVIGATION BAR - With active tab indicator

def create_nav_bar(active_tab="Home"):
    """
    Creates navigation bar with visual indicator for active tab.
    """

    tab_names = ["Home", "My Plants", "Soil", "Climate", "Search", "Logbook", "Plant Bot"]
    tab_buttons = []

    for name in tab_names:
        btn = widgets.Button(description=name)
        btn.add_class("nav-btn")

        # Add active class if this is the current tab
        if name == active_tab:
            btn.add_class("nav-btn-active")

        tab_buttons.append(btn)

    buttons_box = widgets.HBox(tab_buttons, layout=widgets.Layout(gap='10px'))

    nav_bar = widgets.HBox(
        [logo, buttons_box],
        layout=widgets.Layout(
            width='100%',
            justify_content='space-between',
            align_items='center',
            padding='10px 40px 10px 40px',
            height='70px'
        )
    )
    nav_bar.add_class("nav-bar-container")

    # Enhanced CSS with active state
    display(HTML("""
    <style>
        .nav-bar-container {
            background: linear-gradient(90deg, #1F4D36 0%, #2C5F4B 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-btn {
            background-color: transparent !important;
            color: #F0F7F4 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 20px !important;
            padding: 0 20px !important;
            height: 35px !important;
            transition: all 0.3s ease !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px);
            color: white !important;
        }

        .nav-btn-active {
            background-color: rgba(255, 255, 255, 0.25) !important;
            border-bottom: 3px solid white !important;
            color: white !important;
        }

        .nav-btn:active, .nav-btn:focus {
            background-color: rgba(255, 255, 255, 0.3) !important;
            transform: translateY(0);
        }
    </style>
    """))

    # Connect buttons to screens
    def make_handler(screen_func, tab_name):
        def handler(b):
            show_in_container_with_active_tab(screen_func, tab_name)
        return handler

    screen_map = {
        "Home": home_screen,
        "My Plants": upload_screen,
        "Soil": soil_screen,
        "Climate": climate_screen,
        "Search": search_screen,
        "Logbook": logbook_screen,
        "Plant Bot": plant_bot_screen
    }

    for i, btn in enumerate(tab_buttons):
        name = tab_names[i]
        if name in screen_map:
            btn.on_click(make_handler(screen_map[name], name))

    return nav_bar


def show_in_container_with_active_tab(func, tab_name):
    """Switch screen and update active tab indicator."""
    content = func()
    nav = create_nav_bar(active_tab=tab_name)
    main_container.children = [nav, content]

"""---
# 9. Upload Screen (Plant Health Check) <a id="plant-check"></a>

### ğŸ“¸ Upload & Analysis Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Select Image â”‚ â”€â”€â–º â”‚ Display      â”‚ â”€â”€â–º â”‚ AI Analysis  â”‚ â”€â”€â–º â”‚ Show Results â”‚
â”‚ from device  â”‚     â”‚ Preview      â”‚     â”‚ MobileNetV2  â”‚     â”‚ & Advice     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ§  AI Analysis Process

1. **Image Preprocessing**:
   - Convert to RGB mode
   - Resize for model input
   
2. **Classification**:
   - Hugging Face pipeline
   - Model: `mobilenet_v2_1.0_224-plant-disease-identification`
   - Returns: Top 5 predictions with confidence scores

3. **Result Processing**:
   - Clean label names (remove underscores)
   - Match to advice database
   - Generate treatment recommendations
"""

def upload_screen():
    selected_files = {}
    pagination_state = {'current_page': 0}
    ITEMS_PER_PAGE = 5


    uploader_container = widgets.Box()

    display(HTML("""
    <style>
        .panel-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .custom-btn {
            margin-bottom: 10px;
            width: 100%;
            border-radius: 12px !important;
            font-weight: 600;
        }
        .result-card {
            background: linear-gradient(135deg, #E3F4E0 0%, #D4EDDA 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border-left: 5px solid #2C5F4B;
        }
        .confidence-bar {
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            overflow: hidden;
            margin-top: 6px;
        }
        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>

    <script>
        (function(){
          function hideUploadCounter(){
            document.querySelectorAll('.widget-upload .file-upload-counter')
              .forEach(el => el.style.display = 'none');
          }

          hideUploadCounter();

          const obs = new MutationObserver(hideUploadCounter);
          obs.observe(document.body, { childList:true, subtree:true });
        })();
    </script>
    """))

    analysis_output = widgets.Output(layout=widgets.Layout(width='100%'))
    preview_output = widgets.Output(layout=widgets.Layout(width='100%', min_height='300px'))
    history_output = widgets.Output(layout=widgets.Layout(width='100%', display='none'))

    def display_preview(file_dict):
        preview_output.clear_output()
        count_label.value = f"ğŸ“· {len(file_dict)} selected" if file_dict else "No photos"

        if len(file_dict) > 0:
            analyze_button.disabled = False
            analyze_button.button_style = 'success'
            analyze_button.description = "ğŸ”¬ Analyze Plant"
            upload_button.disabled = False
            upload_button.button_style = 'primary'
        else:
            analyze_button.disabled = True
            analyze_button.button_style = ''
            upload_button.disabled = True
            upload_button.button_style = ''

        with preview_output:
            if not file_dict:
                display(HTML("""
                <div style='text-align:center; padding: 40px 20px;'>
                    <div style='font-size: 60px; margin-bottom:15px;'>ğŸŒ±</div>
                    <h3 style='color: #2C5F4B; margin: 0 0 10px 0; font-size: 20px;'>Upload a Plant Photo</h3>
                    <p style='color: #666; font-size: 14px; margin-bottom: 25px;'>
                        Get instant disease detection and care advice
                    </p>

                    <div style='
                        background: #f8f9fa;
                        border-radius: 12px;
                        padding: 18px;
                        text-align: left;
                        max-width: 350px;
                        margin: 0 auto;
                    '>
                        <div style='font-size: 13px; color: #2C5F4B; font-weight: 600; margin-bottom: 12px;'>
                            ğŸ“¸ Tips for best results:
                        </div>
                        <div style='font-size: 13px; color: #555; line-height: 2;'>
                            âœ“ Close-up of leaves or affected area<br>
                            âœ“ Good lighting (natural is best)<br>
                            âœ“ Clear focus, avoid blur<br>
                            âœ“ Single plant per photo
                        </div>
                    </div>
                </div>
                """))
                return

            for filename, content in file_dict.items():
                content_b64 = "data:image/jpeg;base64," + base64.b64encode(content).decode('utf-8')

                def remove_file(filename_to_remove):
                    if filename_to_remove in selected_files:
                        del selected_files[filename_to_remove]
                    display_preview(selected_files)
                    analysis_output.clear_output()

                remove_button = widgets.Button(
                    description='âœ• Remove',
                    button_style='danger',
                    layout=widgets.Layout(width='100px', height='32px')
                )
                remove_button.on_click(lambda b, f=filename: remove_file(f))

                short_name = filename[:30] + "..." if len(filename) > 30 else filename

                display(HTML(f"""
                <div style='text-align: center; padding: 15px;'>
                    <div style='
                        display: inline-block;
                        border-radius: 15px;
                        overflow: hidden;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                        border: 3px solid #E3F4E0;
                        max-width: 100%;
                    '>
                        <img src="{content_b64}" style='
                            max-width: 400px;
                            max-height: 280px;
                            width: auto;
                            height: auto;
                            display: block;
                            object-fit: contain;
                            background: #f9f9f9;
                        '/>
                    </div>
                    <div style='margin-top: 10px; color: #666; font-size: 12px;'>ğŸ“ {short_name}</div>
                </div>
                """))

                display(widgets.HBox([remove_button], layout=widgets.Layout(justify_content='center')))

    def on_files_change(change):
        ALLOWED_FILES = ('.jpg', '.jpeg', '.png')
        new_data = change['new']
        selected_files.clear()

        if not new_data:
            display_preview(selected_files)
            return

        if isinstance(new_data, dict):
            for fname, info in new_data.items():
                if not fname.lower().endswith(ALLOWED_FILES):
                    analysis_output.clear_output()
                    with analysis_output:
                        display(HTML("""
                        <div style='background:#FFC107; padding:20px; border-radius:12px; solid #F0AD4E;'>
                            <h4 style='margin:0 0 8px 0; color:#856404;'>Invalid file!</h4>
                            <p style='margin:0; font-size:13px; color:#856404;'>
                                Please upload a valid image file (JPG, PNG, JPEG).
                            </p>
                        </div>
                        """))
                    return
                selected_files[fname] = info['content']
        else:
            for file_info in new_data:
                selected_files[file_info['name']] = file_info['content']

        reset_uploader_ui()
        display_preview(selected_files)
        analysis_output.clear_output()
        preview_output.layout.display = 'block'
        analysis_output.layout.display = 'block'
        history_output.layout.display = 'none'

    def create_uploader():
        new_uploader = widgets.FileUpload(
            accept='image/*',
            multiple=False,
            description='ğŸ“· Select Photo',
            button_style='success',
            layout=widgets.Layout(width='100%', height='42px')
        )
        new_uploader.add_class("custom-btn")
        new_uploader.observe(on_files_change, names='value')
        return new_uploader

    def reset_uploader_ui():
        uploader_container.children = [create_uploader()]

    def on_analyze_click(b):
        if not selected_files:
            return

        b.disabled = True
        b.description = "â³ Analyzing..."
        analysis_output.clear_output()
        analysis_output.layout.display = 'block'

        with analysis_output:
            display(HTML("""
                <div style='text-align:center; padding: 30px; background: #f8f9fa; border-radius: 12px; margin-top: 15px;'>
                    <div style='font-size: 40px; margin-bottom:10px;'>ğŸ”¬</div>
                    <p style='color:#2C5F4B; font-weight:600; margin: 0 0 5px 0;'>Analyzing your plant...</p>
                    <p style='color:#888; font-size: 12px; margin: 0;'>Checking for diseases and health issues</p>
                </div>
            """))

        try:
            add_reward(5,5)
            time.sleep(0.3)
            first_filename = list(selected_files.keys())[0]
            image_bytes = selected_files[first_filename]
            result = analyze_plant_image(image_bytes)

            analysis_output.clear_output()

            with analysis_output:
                if result["success"] and result["results"]:
                    top = result["top_prediction"]
                    confidence = top["confidence"]
                    all_results = result["results"][:3]

                    plant_keywords = ['plant', 'leaf', 'flower', 'tomato', 'pepper', 'potato', 'corn',
                                      'apple', 'grape', 'cherry', 'peach', 'strawberry', 'squash',
                                      'healthy', 'disease', 'blight', 'rust', 'spot', 'mildew', 'scab']

                    is_plant = any(kw in top["raw_label"].lower() for kw in plant_keywords)

                    if not is_plant or confidence < 15:
                        display(HTML("""
                        <div style='background: #FFF3CD; padding: 20px; border-radius: 12px; margin-top: 15px; border-left: 4px solid #F0AD4E;'>
                            <div style='display: flex; align-items: center; margin-bottom: 12px;'>
                                <span style='font-size: 30px; margin-right: 12px;'>ğŸ¤”</span>
                                <h3 style='margin: 0; color: #856404; font-size: 16px;'>This doesn't look like a plant</h3>
                            </div>
                            <p style='color: #856404; margin: 0; font-size: 13px;'>
                                Please upload a clear photo of plant leaves, stems, or flowers for accurate disease detection.
                            </p>
                        </div>
                        """))
                    else:
                        advice = get_disease_advice(top["raw_label"])

                        is_healthy = "healthy" in top["raw_label"].lower()
                        status_icon = "ğŸŒ¿" if is_healthy else "ğŸ”"

                        results_html = ""
                        for i, r in enumerate(all_results):
                            is_top = i == 0
                            row_style = "background: #f0fff0; border: 1px solid #2C5F4B30;" if is_top else "background: #fafafa;"
                            badge = "<span style='background:#2C5F4B; color:white; padding:2px 8px; border-radius:10px; font-size:10px; margin-left:8px;'>BEST MATCH</span>" if is_top else ""

                            if r['confidence'] >= 50:
                                bar_color = "#2C5F4B"
                            elif r['confidence'] >= 25:
                                bar_color = "#F0AD4E"
                            else:
                                bar_color = "#999"

                            results_html += f"""
                            <div style='{row_style} padding: 12px; border-radius: 8px; margin-bottom: 8px;'>
                                <div style='display: flex; justify-content: space-between; align-items: center;'>
                                    <span style='font-size: 13px; color: #333; font-weight: {"600" if is_top else "400"};'>
                                        {r['label']}{badge}
                                    </span>
                                    <span style='font-size: 14px; font-weight: bold; color: {bar_color};'>{r['confidence']}%</span>
                                </div>
                                <div class='confidence-bar'>
                                    <div class='confidence-fill' style='width: {r['confidence']}%; background: {bar_color};'></div>
                                </div>
                            </div>
                            """

                        display(HTML(f"""
                        <div class='result-card'>
                            <div style='display: flex; align-items: center; margin-bottom: 15px;'>
                                <span style='font-size: 32px; margin-right: 12px;'>{status_icon}</span>
                                <h3 style='margin: 0; color: #2C5F4B; font-size: 18px;'>Analysis Complete</h3>
                            </div>

                            <div style='background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;'>
                                <div style='font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;'>
                                    ğŸ¯ Top 3 Possible Conditions
                                </div>
                                {results_html}
                            </div>

                            <div style='background: {advice["color"]}15; padding: 15px; border-radius: 10px; border-left: 4px solid {advice["color"]};'>
                                <div style='font-weight: 600; color: {advice["color"]}; font-size: 14px; margin-bottom: 8px;'>
                                    ğŸ’¡ Recommended Action
                                </div>
                                <p style='margin: 0; color: #555; font-size: 13px; line-height: 1.6;'>
                                    {advice["advice"]}
                                </p>
                            </div>
                        </div>
                        """))
                else:
                    display(HTML("""
                    <div style='background: #F8D7DA; padding: 25px; border-radius: 12px; text-align: center; margin-top: 15px;'>
                        <div style='font-size: 40px; margin-bottom: 12px;'>ğŸ˜•</div>
                        <h3 style='color: #721C24; margin: 0 0 10px 0; font-size: 16px;'>Couldn't Analyze Image</h3>
                        <p style='color: #721C24; font-size: 13px; margin: 0;'>Please try with a clearer plant photo</p>
                    </div>
                    """))

        except Exception as e:
            analysis_output.clear_output()
            with analysis_output:
                display(HTML(f"""
                <div style='background: #F8D7DA; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;'>
                    <div style='font-size: 40px; margin-bottom: 12px;'>âš ï¸</div>
                    <h3 style='color: #721C24; margin: 0 0 10px 0; font-size: 16px;'>Analysis Error</h3>
                    <p style='color: #721C24; font-size: 13px; margin: 0;'>Something went wrong. Please try again.</p>
                </div>
                """))

        finally:
            b.disabled = False
            b.description = "ğŸ”¬ Analyze Plant"

    def on_upload_click(b):
        if not selected_files:
            return
        b.disabled = True
        b.description = "â˜ï¸ Saving..."

        try:
            add_reward(2,5)
            uploaded_count = 0
            errors = []
            for filename, content in selected_files.items():
                try:
                    save_uploaded_file_to_firebase(filename, {"content_b64": base64.b64encode(content).decode('utf-8')})
                    uploaded_count += 1
                except Exception as e:
                    errors.append(f"{filename}: {str(e)}")

            analysis_output.clear_output()
            with analysis_output:
                display(HTML(f"""
                    <div style='background: #D4EDDA; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;'>
                        <div style='font-size: 35px; margin-bottom: 8px;'>âœ…</div>
                        <span style='color: #155724; font-weight: 600; font-size: 15px;'>Saved {uploaded_count} photo(s) to cloud!</span>
                    </div>
                """))

            time.sleep(2)

            selected_files.clear()
            reset_uploader_ui()
            display_preview({})
            analysis_output.clear_output()

        except Exception as e:
            analysis_output.clear_output()
            with analysis_output:
                display(HTML("""
                    <div style='background: #F8D7DA; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;'>
                        <div style='font-size: 35px; margin-bottom: 8px;'>âš ï¸</div>
                        <span style='color: #721C24; font-weight: 600; font-size: 15px;'>Upload failed. Please try again.</span>
                    </div>
                """))

        finally:
            b.disabled = False
            b.description = "â˜ï¸ Save to Cloud"

    def toggle_history(b):
        if history_output.layout.display == 'none':
            b.description = "ğŸ“· Back to Upload"
            b.button_style = 'info'
            preview_output.layout.display = 'none'
            analysis_output.layout.display = 'none'
            history_output.layout.display = 'block'
            load_history()
        else:
            b.description = "ğŸ“œ View History"
            b.button_style = 'warning'
            preview_output.layout.display = 'block'
            analysis_output.layout.display = 'block'
            history_output.layout.display = 'none'

    def load_history():
        history_output.clear_output()
        with history_output:
            history = get_upload_history_from_firebase()

            if not history:
                display(HTML("""
                    <div style='text-align:center; padding: 60px 20px; color:#999;'>
                        <div style='font-size: 50px; margin-bottom:15px;'>ğŸ“­</div>
                        <h3 style='margin: 0 0 8px 0; color: #666;'>No Saved Photos</h3>
                        <p style='font-size: 13px; margin: 0;'>Photos you save will appear here</p>
                    </div>
                """))
                return

            display(HTML("<h4 style='color:#2C5F4B; margin: 0 0 15px 0;'>ğŸ“œ Your Saved Photos</h4>"))

            total_items = len(history)
            total_pages = (total_items + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE
            curr_page = pagination_state['current_page']
            page_items = history[curr_page * ITEMS_PER_PAGE : (curr_page + 1) * ITEMS_PER_PAGE]

            for item in page_items:
                def make_delete_handler(f_id):
                    def handler(btn):
                        delete_file_from_firebase(f_id)
                        load_history()
                    return handler

                del_btn = widgets.Button(description='ğŸ—‘ï¸', button_style='danger', layout=widgets.Layout(width='35px', height='35px'))
                del_btn.on_click(make_delete_handler(item['id']))

                display_name = item['filename'][:20] + "..." if len(item['filename']) > 20 else item['filename']

                row = widgets.HBox([
                    widgets.HTML(f"""
                        <div style='display:flex; align-items:center;'>
                            <img src="data:image/jpeg;base64,{item["content_b64"]}" style="width:45px; height:45px; object-fit:cover; border-radius:8px; margin-right:12px; border: 1px solid #eee;"/>
                            <div>
                                <div style='font-weight:600; font-size:13px; color:#333;'>{display_name}</div>
                                <div style='font-size:11px; color:#888;'>ğŸ“… {item['timestamp']}</div>
                            </div>
                        </div>
                    """),
                    del_btn
                ], layout=widgets.Layout(justify_content='space-between', align_items='center', width='100%', padding='10px', margin='0 0 8px 0', border='1px solid #eee', border_radius='10px'))

                display(row)

            if total_pages > 1:
                def go_page(direction):
                    def handler(_):
                        pagination_state['current_page'] = max(0, min(pagination_state['current_page'] + direction, total_pages - 1))
                        load_history()
                    return handler

                prev_btn = widgets.Button(description="â—€", disabled=(curr_page == 0), layout=widgets.Layout(width='40px'))
                next_btn = widgets.Button(description="â–¶", disabled=(curr_page >= total_pages - 1), layout=widgets.Layout(width='40px'))
                prev_btn.on_click(go_page(-1))
                next_btn.on_click(go_page(1))

                nav = widgets.HBox([prev_btn, widgets.Label(value=f"{curr_page + 1} / {total_pages}"), next_btn],
                                   layout=widgets.Layout(justify_content='center', margin='15px 0 0 0'))
                display(nav)

    uploader_container.children = [create_uploader()]

    analyze_button = widgets.Button(description='ğŸ”¬ Analyze Plant', button_style='', disabled=True, layout=widgets.Layout(width='100%', height='45px'))
    analyze_button.add_class("custom-btn")
    analyze_button.on_click(on_analyze_click)

    upload_button = widgets.Button(description='â˜ï¸ Save to Cloud', button_style='', disabled=True, layout=widgets.Layout(width='100%', height='40px'))
    upload_button.add_class("custom-btn")
    upload_button.on_click(on_upload_click)

    history_toggle = widgets.Button(description="ğŸ“œ View History", button_style='warning', layout=widgets.Layout(width='100%', height='35px'))
    history_toggle.add_class("custom-btn")
    history_toggle.on_click(toggle_history)

    count_label = widgets.Label(value="No photos", layout=widgets.Layout(margin='5px 0'))

    display_preview({})

    control_column = widgets.VBox([
        widgets.HTML("<h3 style='color:#2C5F4B; margin:0 0 10px 0; font-size:17px;'>ğŸŒ¿ Plant Health Check</h3>"),
        uploader_container,
        count_label,
        widgets.HTML("<hr style='border:0; border-top:1px solid #eee; margin: 12px 0;'>"),
        analyze_button,
        upload_button,
        widgets.HTML("<hr style='border:0; border-top:1px solid #eee; margin: 12px 0;'>"),
        history_toggle
    ])
    control_column.add_class("panel-card")
    control_column.layout.width = '240px'
    control_column.layout.margin = '0 20px 0 0'

    display_column = widgets.VBox([
        preview_output,
        analysis_output,
        history_output
    ])
    display_column.add_class("panel-card")
    display_column.layout.width = '600px'
    display_column.layout.min_height = '480px'

    return widgets.VBox([
        widgets.HBox([control_column, display_column], layout=widgets.Layout(width='100%', justify_content='center'))
    ], layout=widgets.Layout(align_items='center', width='100%', padding='20px'))


def get_simple_explanation(disease_label):
    """Provide simple, user-friendly explanation of the detection."""

    label_lower = disease_label.lower()

    explanations = {
        "healthy": "Your plant appears to be in good health! No signs of disease or stress were detected.",
        "bacterial": "Bacterial infection detected. These are caused by microscopic organisms and often appear as spots or wilting.",
        "spot": "Leaf spots are areas of dead tissue, usually caused by fungal or bacterial infections.",
        "rust": "Rust is a fungal disease that creates orange/brown powdery spots on leaves.",
        "blight": "Blight causes rapid browning and death of plant tissue. It spreads quickly in humid conditions.",
        "mildew": "Mildew appears as white/gray powdery coating on leaves. It thrives in humid conditions.",
        "wilt": "Wilting occurs when plants can't get enough water, often due to root problems or disease.",
        "yellow": "Yellowing leaves can indicate overwatering, nutrient deficiency, or natural aging.",
        "mosaic": "Mosaic virus causes mottled patterns on leaves. It's spread by insects and infected tools.",
        "scab": "Scab is a fungal disease causing rough, raised spots on leaves and fruit.",
    }

    for key, explanation in explanations.items():
        if key in label_lower:
            return explanation

    return f"The AI detected signs that match '{disease_label.replace('_', ' ')}'. This identification is based on visual patterns in your image."

"""---
# 10. Climate & Soil Monitoring <a id="climate"></a>

```

### ğŸ“Š Chart Features
- **Zone coloring**: Visual bands for ideal/warning ranges
- **Line plot**: Historical trend with markers
- **Auto-scaling**: X-axis adapts to time range
- **Statistics**: Min/Max/Avg calculated from data
- **Recommendations**: Actionable advice based on current reading

### ğŸ¨ Status Colors
| Range | Temperature | Humidity | Soil | Color |
|-------|-------------|----------|------|-------|
| Low | <15Â°C | <40% | <30% | Blue (#0B5ED7) |
| Ideal | 15-30Â°C | 40-80% | 30-70% | Green (#2C5F4B) |
| High | >30Â°C | >80% | >70% | Red (#D9534F) |

"""

def climate_card(feed, title, unit, min_ok, max_ok, ylim, line_color):

    #Widgets
    limit_slider = widgets.IntSlider(
        value=30, min=5, max=60, step=5,
        description='',
        continuous_update=False,
        layout=widgets.Layout(width='250px')
    )

    slider_label = widgets.Label(
        value="Show last records:",
        layout=widgets.Layout(margin='0 10px 0 0')
    )

    refresh_btn = widgets.Button(
        description="ğŸ”„ Refresh",
        button_style='info',
        layout=widgets.Layout(width='100px', height='35px')
    )

    graph_out = widgets.Output()
    status_header_out = widgets.Output()

    # Recommendation functions (kept)
    def get_recommendation_for_temp(value):
        if value < 15:
            return "ğŸ”¥ Consider moving plants to warmer spot", "#0B5ED7"
        elif value > 30:
            return "ğŸ’¨ Increase ventilation or provide shade", "#D9534F"
        else:
            return "âœ… Temperature is perfect for most plants", "#2C5F4B"

    def get_recommendation_for_humidity(value):
        if value < 40:
            return "ğŸ’§ Air is too dry. Mist leaves or use a humidifier", "#0B5ED7"
        elif value > 80:
            return "ğŸ’¨ Humidity is too high. Ensure airflow to prevent mold", "#D9534F"
        else:
            return "âœ… Humidity levels are optimal for most plants", "#2C5F4B"

    # Update
    def update_view(change=None):
        limit = limit_slider.value
        start_background_fetch()
        data_list = get_sensor_history_from_firebase(feed, limit)

        graph_out.clear_output()
        status_header_out.clear_output()

        if not data_list:
            with status_header_out:
                display(HTML(f"""
                    <div style='text-align:center; padding:50px; color:#999;'>
                        <h3>No {title} Data Available</h3>
                        <p>Sensor data will appear here once available</p>
                    </div>
                """))
            return

        df = pd.DataFrame(data_list)
        df["created_at"] = pd.to_datetime(df["timestamp"])
        df["value"] = pd.to_numeric(df["value"], errors="coerce")
        df = df.sort_values(by="created_at")


        latest_val = df.iloc[-1]["value"]
        latest_time = df.iloc[-1]["timestamp"]

        min_val = df["value"].min()
        max_val = df["value"].max()
        avg_val = df["value"].mean()

        # Status + Recommendation
        if feed == "temperature":
            if latest_val < 15:
                status_text, status_color, icon = "Cold", "#0B5ED7", "â„ï¸"
            elif latest_val > 30:
                status_text, status_color, icon = "Hot", "#D9534F", "ğŸ”¥"
            else:
                status_text, status_color, icon = "Ideal", "#2C5F4B", "ğŸŒ¿"
            recommendation, rec_color = get_recommendation_for_temp(latest_val)

        elif feed == "humidity":
            if latest_val < 40:
                status_text, status_color, icon = "Dry", "#0B5ED7", "ğŸ’§"
            elif latest_val > 80:
                status_text, status_color, icon = "Humid", "#D9534F", "ğŸŒ«ï¸"
            else:
                status_text, status_color, icon = "Ideal", "#2C5F4B", "ğŸŒ¿"
            recommendation, rec_color = get_recommendation_for_humidity(latest_val)

        # Header
        with status_header_out:
            display(HTML(f"""
            <div style='display:flex; justify-content:space-between; padding-bottom:20px; border-bottom:1px solid #eee;'>
                <div>
                    <div style='font-size:11px; color:#999; font-weight:700;'>Current {title}</div>
                    <div style='display:flex; align-items:baseline;'>
                        <span style='font-size:56px; font-weight:800; color:{status_color};'>
                            {latest_val}{unit}
                        </span>
                        <div style='margin-left:15px;'>
                            <div style='font-size:20px; font-weight:600;'>{icon} {status_text}</div>
                            <div style='font-size:11px; color:#888;'>{latest_time}</div>
                        </div>
                    </div>
                    <div style='margin-top:12px; padding:8px 15px;
                                background:{rec_color}15;
                                border-left:4px solid {rec_color};'>
                        <b style='color:{rec_color};'>{recommendation}</b>
                    </div>
                </div>

                <div style='background:#f8f9fa; padding:12px 15px; border-radius:10px;'>
                    <div style='font-size:10px; color:#999; font-weight:700;'>STATISTICS</div>
                    Min: <b>{min_val}{unit}</b><br>
                    Max: <b>{max_val}{unit}</b><br>
                    Avg: <b>{avg_val:.1f}{unit}</b>
                </div>
            </div>
            """))

# Graph
        with graph_out:
            fig, ax = plt.subplots(figsize=(9, 3.5))
            ax.plot(df["created_at"], df["value"], marker="o", linewidth=2, color=line_color)

            if feed == "temperature":
                ax.axhspan(0, min_ok, color='#0B5ED7', alpha=0.08)
                ax.axhspan(min_ok, max_ok, color='#2C5F4B', alpha=0.08)
                ax.axhspan(max_ok, ylim[1], color='#D9534F', alpha=0.08)
                ax.text(df["created_at"].iloc[-1], 7, 'COLD', fontsize=9, color='#0B5ED7', alpha=0.5, ha='right')
                ax.text(df["created_at"].iloc[-1], 22, 'IDEAL', fontsize=9, color='#2C5F4B', alpha=0.5, ha='right')
                ax.text(df["created_at"].iloc[-1], 40, 'HOT', fontsize=9, color='#D9534F', alpha=0.5, ha='right')

            elif feed == "humidity":
                ax.axhspan(0, min_ok, color='#0B5ED7', alpha=0.08)
                ax.axhspan(min_ok, max_ok, color='#2C5F4B', alpha=0.08)
                ax.axhspan(max_ok, ylim[1], color='#D9534F', alpha=0.08)
                ax.text(df["created_at"].iloc[-1], 20, 'DRY', fontsize=9, color='#0B5ED7', alpha=0.5, ha='right')
                ax.text(df["created_at"].iloc[-1], 60, 'IDEAL', fontsize=9, color='#2C5F4B', alpha=0.5, ha='right')
                ax.text(df["created_at"].iloc[-1], 90, 'HUMID', fontsize=9, color='#D9534F', alpha=0.5, ha='right')

            ax.set_ylim(*ylim)
            ax.set_ylabel(f"{title} {unit}")
            ax.grid(True, linestyle=':', alpha=0.4)
            ax.spines['top'].set_visible(False)
            ax.spines['right'].set_visible(False)
            plt.tight_layout()
            plt.show()

    limit_slider.observe(update_view, names='value')
    refresh_btn.on_click(update_view)
    update_view()

    controls_row = widgets.HBox([slider_label, limit_slider, refresh_btn],
        layout=widgets.Layout(justify_content='center', margin='0 0 15px 0'))

    card = widgets.VBox([status_header_out, controls_row, graph_out])
    card.add_class("monitor-card")

    display(HTML("""
    <style>
        .monitor-card {
            background:white;
            padding:30px;
            border-radius:20px;
            width:900px;
            box-shadow:0 6px 20px rgba(0,0,0,0.06);
            margin-bottom:30px;
        }
    </style>
    """))

    return widgets.VBox([card], layout=widgets.Layout(align_items='center', padding='20px'))

# 11. Climate Screen
def climate_screen():
  return (widgets.VBox([
      climate_card("temperature", "Temperature", "Â°C", 15, 30, (0, 50), "#d62728"),
      climate_card("humidity", "Humidity", "%", 40, 80, (0, 100), "#1f77b4")
  ]))

# 12. Soil Screen
def soil_screen():

    feed = "soil"

    #Widgets
    limit_slider = widgets.IntSlider(
        value=30, min=5, max=60, step=5,
        description='',
        continuous_update=False,
        layout=widgets.Layout(width='250px')
    )

    slider_label = widgets.Label(
        value="Show last records:",
        layout=widgets.Layout(margin='0 10px 0 0')
    )

    refresh_btn = widgets.Button(
        description="ğŸ”„ Refresh",
        button_style='info',
        layout=widgets.Layout(width='100px', height='35px')
    )

    graph_out = widgets.Output()
    status_header_out = widgets.Output()

    def get_recommendation(value):
        """Return actionable recommendation based on soil moisture."""
        if value < 30:
            return "ğŸ’§ Water your plants soon!", "#D9534F"
        elif value <= 70:
            return "âœ… No action needed", "#2C5F4B"
        else:
            return "â¸ï¸ Skip watering for now", "#0B5ED7"

    def update_view(change=None):
        limit = limit_slider.value
        start_background_fetch()
        data_list = get_sensor_history_from_firebase(feed, limit)

        graph_out.clear_output()
        status_header_out.clear_output()

        if not data_list:
            with status_header_out:
                display(HTML("""
                    <div style='text-align:center; padding: 50px; color: #999;'>
                        <div style='font-size: 50px; margin-bottom: 15px;'>ğŸ“Š</div>
                        <h3>No Soil Data Available</h3>
                        <p>Sensor data will appear here once available</p>
                    </div>
                """))
            return

        # Process data
        df = pd.DataFrame(data_list)
        df["created_at"] = pd.to_datetime(df["timestamp"])
        df["value"] = pd.to_numeric(df["value"], errors="coerce")
        df = df.sort_values(by="created_at")


        latest_val = df.iloc[-1]["value"]
        latest_time = df.iloc[-1]["timestamp"]

        # Statistics
        min_val = df["value"].min()
        max_val = df["value"].max()
        avg_val = df["value"].mean()

        # Status determination
        if latest_val < 30:
            status_text, color = "Dry", "#D9534F"
        elif latest_val <= 70:
            status_text, color = "Perfect", "#2C5F4B"
        else:
            status_text, color = "Wet", "#0B5ED7"

        recommendation, rec_color = get_recommendation(latest_val)

        # Header with Status
        with status_header_out:
            display(HTML(f"""
            <div style='
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                padding-bottom: 20px;
                margin-bottom: 15px;
                border-bottom: 1px solid #eee;
            '>
                <!-- Left: Current Value -->
                <div style='flex: 1;'>
                    <div style='font-size: 11px; color: #999; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px;'>
                        Current Moisture
                    </div>
                    <div style='display: flex; align-items: baseline;'>
                        <span style='font-size: 56px; font-weight: 800; color: {color}; line-height: 1;'>{int(latest_val)}%</span>
                        <div style='margin-left: 15px;'>
                            <div style='font-size: 20px; color: #333; font-weight: 600;'>{status_text}</div>
                            <div style='font-size: 11px; color: #888;'>{latest_time}</div>
                        </div>
                    </div>

                    <!-- Recommendation Banner -->
                    <div style='
                        margin-top: 12px;
                        padding: 8px 15px;
                        background: {rec_color}15;
                        border-left: 4px solid {rec_color};
                        border-radius: 0 8px 8px 0;
                        display: inline-block;
                    '>
                        <span style='color: {rec_color}; font-weight: 600; font-size: 13px;'>{recommendation}</span>
                    </div>
                </div>

                <!-- Right: Reference Guide + Stats -->
                <div style='display: flex; gap: 20px;'>

                    <!-- Statistics Box -->
                    <div style='
                        background: #f8f9fa;
                        padding: 12px 15px;
                        border-radius: 10px;
                        min-width: 100px;
                    '>
                        <div style='font-size: 10px; color: #999; font-weight: 700; text-transform: uppercase; margin-bottom: 8px;'>
                            Statistics
                        </div>
                        <div style='font-size: 12px; color: #555; margin-bottom: 4px;'>
                            <span style='color: #999;'>Min:</span> <strong>{int(min_val)}%</strong>
                        </div>
                        <div style='font-size: 12px; color: #555; margin-bottom: 4px;'>
                            <span style='color: #999;'>Max:</span> <strong>{int(max_val)}%</strong>
                        </div>
                        <div style='font-size: 12px; color: #555;'>
                            <span style='color: #999;'>Avg:</span> <strong>{int(avg_val)}%</strong>
                        </div>
                    </div>

                    <!-- Reference Guide -->
                    <div style='
                        background: #fdfdfd;
                        padding: 12px 15px;
                        border-radius: 10px;
                        border: 1px solid #eee;
                        min-width: 130px;
                    '>
                        <div style='font-size: 10px; color: #999; font-weight: 700; text-transform: uppercase; margin-bottom: 8px;'>
                            Reference Guide
                        </div>
                        <div style='display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: #D9534F;'>
                            <span>ğŸŒµ Dry</span> <span>0-30%</span>
                        </div>
                        <div style='display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: #2C5F4B;'>
                            <span>ğŸŒ± Perfect</span> <span>30-70%</span>
                        </div>
                        <div style='display: flex; justify-content: space-between; font-size: 12px; color: #0B5ED7;'>
                            <span>ğŸ’§ Wet</span> <span>70%+</span>
                        </div>
                    </div>
                </div>
            </div>
            """))

        # Graph
        with graph_out:
            fig, ax = plt.subplots(figsize=(9, 3.5))

            ax.plot(
                df["created_at"],
                df["value"],
                marker="o",
                linestyle='-',
                color='#8B4513',
                linewidth=2,
                markersize=4
            )

            # Background zones
            ax.axhspan(0, 30, color='#D9534F', alpha=0.08)
            ax.axhspan(30, 70, color='#2C5F4B', alpha=0.08)
            ax.axhspan(70, 100, color='#0B5ED7', alpha=0.08)

            # Zone labels on right side
            ax.text(df["created_at"].iloc[-1], 15, 'DRY', fontsize=9, color='#D9534F', alpha=0.5, ha='right')
            ax.text(df["created_at"].iloc[-1], 50, 'PERFECT', fontsize=9, color='#2C5F4B', alpha=0.5, ha='right')
            ax.text(df["created_at"].iloc[-1], 85, 'WET', fontsize=9, color='#0B5ED7', alpha=0.5, ha='right')

            ax.set_ylim(0, 100)
            ax.set_ylabel('Moisture %', fontsize=10, color='#666')
            ax.grid(True, linestyle=':', alpha=0.4)

            import matplotlib.dates as mdates

            # Auto-format based on data range
            time_range = (df["created_at"].max() - df["created_at"].min()).total_seconds()

            if time_range < 3600:  # Less than 1 hour
                ax.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M:%S'))
            elif time_range < 86400:  # Less than 1 day
                ax.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M'))
            else:
                ax.xaxis.set_major_formatter(mdates.DateFormatter('%m/%d %H:%M'))

            # Limit number of x-axis labels
            ax.xaxis.set_major_locator(plt.MaxNLocator(6))

            plt.xticks(rotation=0, fontsize=9)
            plt.yticks(fontsize=9)

            # Clean borders
            ax.spines['top'].set_visible(False)
            ax.spines['right'].set_visible(False)

            plt.tight_layout()
            plt.show()

    # Event handlers
    limit_slider.observe(update_view, names='value')
    refresh_btn.on_click(update_view)

    # Initial load
    update_view()

    # CSS
    display(HTML("""
    <style>
        .monitor-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 900px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        }
    </style>
    """))

    # Layout
    controls_row = widgets.HBox([
        slider_label,
        limit_slider,
        refresh_btn
    ], layout=widgets.Layout(
        margin='0 0 15px 0',
        align_items='center',
        justify_content='center'
    ))

    card = widgets.VBox([
        status_header_out,
        controls_row,
        graph_out
    ])
    card.add_class("monitor-card")

    return widgets.VBox([
        card
    ], layout=widgets.Layout(align_items='center', padding='20px'))

"""---
# 11. Logbook Screen <a id="logbook"></a>
```

### ğŸ“‹ Action Types

| Action | Icon | Badge Color |
|--------|------|-------------|
| Watering | ğŸ’§ | Blue (#0B5ED7) |
| Fertilizing | ğŸ§ª | Green (#2C5F4B) |
| Pruning | âœ‚ï¸ | Purple (#6F42C1) |
| Pest Control | ğŸ› | Red (#D9534F) |
| Inspection | ğŸ©º | Orange (#F0AD4E) |

### ğŸ”§ Features
- **Add entry**: Select action type + optional notes
- **Filter**: View only specific action types
- **Delete**: Remove entries with confirmation
- **Timestamps**: Auto-generated on save
- **Persistence**: All data stored in Firebase

### ğŸ® Gamification
- +10 XP, +5 Coins per log entry

"""

#LOGBOOK FEATURE: UI SCREEN
def logbook_screen():
    display(HTML("""
    <style>
        .log-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 900px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .log-row {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        .log-row:hover {
            background: #f9f9f9;
        }
        .delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .log-row:hover .delete-btn {
            opacity: 1;
        }
        .action-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .save-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2C5F4B;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
    """))

    # Action options
    ACTION_OPTIONS = [
        ('ğŸ’§ Watering', 'watering', '#0B5ED7', '#E3F2FD'),
        ('ğŸ§ª Fertilizing', 'fertilizing', '#2C5F4B', '#E3F4E0'),
        ('âœ‚ï¸ Pruning', 'pruning', '#6F42C1', '#F3E5F5'),
        ('ğŸ› Pest Control', 'pest_control', '#D9534F', '#FFEBEE'),
        ('ğŸ©º Inspection', 'inspection', '#F0AD4E', '#FFF8E1'),
    ]

    # Widgets
    action_dropdown = widgets.Dropdown(
        options=[(label, value) for label, value, _, _ in ACTION_OPTIONS],
        value='watering',
        description='',
        layout=widgets.Layout(width='180px')
    )

    notes_input = widgets.Text(
        placeholder='Add details (optional but helpful!)',
        description='',
        layout=widgets.Layout(width='350px')
    )

    submit_btn = widgets.Button(
        description='ğŸ’¾ Save Entry',
        button_style='success',
        layout=widgets.Layout(width='130px', height='38px')
    )

    # Filter dropdown
    filter_dropdown = widgets.Dropdown(
        options=[('All Actions', 'all')] + [(label, value) for label, value, _, _ in ACTION_OPTIONS],
        value='all',
        description='',
        layout=widgets.Layout(width='150px')
    )
    filter_label = widgets.HTML("<span style='color:#666; font-size:13px; margin-right:8px;'>Filter:</span>")

    msg_out = widgets.Output()
    history_out = widgets.Output(layout=widgets.Layout(
        height='380px',
        overflow_y='auto',
        width='100%'
    ))

    def format_date(timestamp_str):
        """Convert '2025-12-23 21:57:40' to 'Dec 23, 21:57'"""
        try:
            from datetime import datetime
            dt = datetime.strptime(timestamp_str, "%Y-%m-%d %H:%M:%S")
            return dt.strftime("%b %d, %H:%M")
        except:
            return timestamp_str

    def get_action_style(action_value):
        """Get color styling for action badge."""
        for label, value, color, bg in ACTION_OPTIONS:
            if value == action_value or action_value in label.lower():
                return color, bg
        return '#666', '#f0f0f0'

    def get_action_display(action_value):
        """Get display label with emoji for action."""
        for label, value, _, _ in ACTION_OPTIONS:
            if value == action_value or action_value in label.lower():
                return label
        return action_value

    def render_table(filter_action='all'):
        """Render the log table with optional filtering."""
        history_out.clear_output()
        logs = get_log_entries_with_ids()

        # Apply filter
        if filter_action != 'all':
            logs = [l for l in logs if filter_action in l.get('action', '').lower()]

        with history_out:
            if not logs:
                display(HTML("""
                    <div style='text-align:center; color:#999; margin-top:80px;'>
                        <div style='font-size: 40px; margin-bottom: 10px;'>ğŸ“</div>
                        <h3 style='margin: 0; color: #666;'>No entries yet</h3>
                        <p style='font-size: 14px;'>Start tracking your plant care above!</p>
                    </div>
                """))
                return

            # Table header
            display(HTML(f"""
                <div style='
                    display: flex;
                    padding: 10px 15px;
                    background: #2C5F4B;
                    color: white;
                    font-weight: 600;
                    font-size: 13px;
                    border-radius: 10px 10px 0 0;
                    position: sticky;
                    top: 0;
                '>
                    <div style='width: 130px;'>Time â†“</div>
                    <div style='width: 150px;'>Action</div>
                    <div style='flex: 1;'>Notes</div>
                    <div style='width: 50px;'></div>
                </div>
            """))

            # Table rows
            for log in logs:
                log_id = log.get('id', '')
                action_raw = log.get('action', '')
                action_display = get_action_display(action_raw)
                color, bg = get_action_style(action_raw)
                notes = log.get('notes', '')
                time_formatted = format_date(log.get('timestamp', ''))

                # Notes display
                if not notes or notes == "No notes":
                    notes_html = "<span style='color: #ccc; font-style: italic;'>â€”</span>"
                else:
                    notes_html = f"<span style='color: #444;'>{html.escape(notes)}</span>"

                # Create delete button for this row
                delete_btn = widgets.Button(
                    description='ğŸ—‘ï¸',
                    button_style='',
                    layout=widgets.Layout(width='35px', height='30px')
                )
                delete_btn.add_class('delete-btn')

                def make_delete_handler(entry_id):
                    def handler(b):
                        if delete_log_entry(entry_id):
                            render_table(filter_dropdown.value)
                    return handler

                delete_btn.on_click(make_delete_handler(log_id))

                # Row HTML
                row_html = widgets.HTML(f"""
                    <div style='display: flex; align-items: center; flex: 1;'>
                        <div style='width: 130px; color: #666; font-size: 13px;'>{time_formatted}</div>
                        <div style='width: 150px;'>
                            <span class='action-badge' style='background: {bg}; color: {color};'>
                                {action_display}
                            </span>
                        </div>
                        <div style='flex: 1; font-size: 14px;'>{notes_html}</div>
                    </div>
                """)

                row = widgets.HBox(
                    [row_html, delete_btn],
                    layout=widgets.Layout(
                        align_items='center',
                        padding='12px 15px',
                        border_bottom='1px solid #f0f0f0'
                    )
                )
                row.add_class('log-row')
                display(row)

    def on_submit(b):
      action = action_dropdown.value
      notes = notes_input.value.strip()

      if not notes:
          notes = ""

      # Get display label
      action_label = get_action_display(action)

      # Show saving indicator
      with msg_out:
          msg_out.clear_output()
          display(HTML("<span style='color:#888;'>ğŸ’¾ Saving...</span>"))

      # Save to Firebase
      save_log_entry(action_label, notes)

      add_reward(10, 5)

      # Clear input
      notes_input.value = ""

      # Refresh table
      render_table(filter_dropdown.value)

      # Clear success message after delay
      time.sleep(2)
      msg_out.clear_output()


    def on_filter_change(change):
        render_table(change['new'])

    submit_btn.on_click(on_submit)
    filter_dropdown.observe(on_filter_change, names='value')

    # Initial render
    render_table()

    # Layout

    # Input section
    title_html = widgets.HTML("""
        <div style='text-align:center; margin-bottom:15px;'>
            <h2 style='color:#2C5F4B; margin:0;'>ğŸ“ Care Logbook</h2>
            <p style='color:#888; font-size:14px; margin-top:5px;'>Track watering, fertilizing, and plant maintenance</p>
        </div>
    """)

    input_row = widgets.HBox([
        widgets.HTML("<span style='color:#666; margin-right:5px;'>Action:</span>"),
        action_dropdown,
        widgets.HTML("<span style='color:#666; margin: 0 10px;'>Notes:</span>"),
        notes_input
    ], layout=widgets.Layout(
        align_items='center',
        justify_content='center',
        margin='0 0 15px 0'
    ))

    button_row = widgets.HBox([
        submit_btn,
        msg_out
    ], layout=widgets.Layout(
        align_items='center',
        justify_content='center',
        gap='15px'
    ))

    input_card = widgets.VBox([
        title_html,
        input_row,
        button_row
    ])
    input_card.add_class("log-card")

    # History section
    filter_row = widgets.HBox([
        filter_label,
        filter_dropdown
    ], layout=widgets.Layout(margin='0 0 10px 0'))

    history_card = widgets.VBox([
        widgets.HTML("<h3 style='color:#2C5F4B; margin:0 0 10px 0;'>ğŸ“… Activity History</h3>"),
        filter_row,
        history_out
    ])
    history_card.add_class("log-card")

    return widgets.VBox([
        input_card,
        history_card
    ], layout=widgets.Layout(align_items='center', padding='20px'))

"""---
# 12. Plant Bot (AI Chatbot) <a id="chatbot"></a>

### ğŸ¤– Hybrid Chatbot Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER MESSAGE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: NLTK Bot (Fast Response)                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ Tokenize & lemmatize input                                        â”‚
â”‚  â€¢ Match against predefined intents (keywords)                       â”‚
â”‚  â€¢ Score: 2 pts for exact match, 1 pt for processed match           â”‚
â”‚  â€¢ If score â‰¥ 1 â†’ Return predefined response                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                          (If NLTK fails)
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Gemini Bot (Complex Queries)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  â€¢ Initialize Gemini with plant expert persona                       â”‚
â”‚  â€¢ Send message to Google Gemini API                                 â”‚
â”‚  â€¢ Return AI-generated response                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                          (If Gemini fails)
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Fallback Response                                           â”‚
â”‚  "I'm not sure about that. Try asking about watering, sunlight..."  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“š NLTK Intent Categories

| Intent | Keywords | Example Response |
|--------|----------|------------------|
| greeting | hi, hello, hey | "Hello! ğŸŒ± How can I help with your plants?" |
| watering | water, watering, thirsty | "ğŸ’§ Check soil moisture by inserting finger..." |
| sunlight | sun, light, shade | "â˜€ï¸ Direct sun: Cacti, Bright indirect: Most plants..." |
| yellow_leaves | yellow, yellowing | "ğŸ‚ Common causes: Overwatering, Underwatering..." |
| pests | pest, bug, insects | "ğŸ› Spider mites: Wipe with soapy water..." |
| fertilizer | fertilizer, feed, nutrient | "ğŸ§ª Fertilize during growing season..." |
| repotting | repot, pot, roots | "ğŸª´ Repot when roots grow out of holes..." |

### ğŸ·ï¸ Response Source Badges
- âš¡ **Quick Response**: NLTK (instant, predefined)
- ğŸ¤– **AI Response**: Gemini (dynamic, contextual)


### Examples:
- âš¡ **Quick Response**: "watering tips".
- ğŸ¤– **AI Response**: "My plant looks sad."


"""

# Gemini API Key
GEMINI_API_KEY = "can't publish api key on git"

RAG_CONFIG = {
    "model_name": "gemini-2.5-flash",
    "max_context_length": 8000,
    "top_k_documents": 5,
    "temperature": 0.3,
    "max_output_tokens": 1024,
}

class RAGSearchEngine:
    def __init__(self, api_key, search_function):
        self.api_key = api_key
        self.search_function = search_function
        self.model = None
        self.initialized = False

    def initialize(self):
        try:
            genai.configure(api_key=self.api_key)
            generation_config = {
                "temperature": RAG_CONFIG["temperature"],
                "top_p": 0.95,
                "top_k": 40,
                "max_output_tokens": RAG_CONFIG["max_output_tokens"],
            }
            system_instruction = """
You are a Plant Care Expert Assistant integrated into the Chameleon smart plant system.

CRITICAL RULES:
1. ONLY answer based on the provided context documents. Do NOT make up information.
2. If the context doesn't contain relevant information, say "I couldn't find specific information about this in our knowledge base."
3. Always cite your sources using [Source: filename, Page X] format.
4. Keep answers concise but complete (under 300 words).
5. Use bullet points for lists and practical advice.
6. If asked about plant diseases, include symptoms AND treatment recommendations.

LANGUAGE: Respond in the same language as the user's question.
"""
            self.model = genai.GenerativeModel(
                model_name=RAG_CONFIG["model_name"],
                generation_config=generation_config,
                system_instruction=system_instruction
            )
            self.initialized = True
            return True
        except Exception as e:
            print(f"Error initializing RAG: {e}")
            return False

    def _build_context(self, search_results):
        if not search_results:
            return ""
        context_parts = []
        total_length = 0
        for i, result in enumerate(search_results):
            doc_text = f"""
--- DOCUMENT {i+1} ---
Source: {result['filename']}, Page {result['page']}
Content:
{result['snippet_full'][:2000]}
--- END DOCUMENT {i+1} ---
"""
            if total_length + len(doc_text) > RAG_CONFIG["max_context_length"]:
                break
            context_parts.append(doc_text)
            total_length += len(doc_text)
        return "\n".join(context_parts)

    def search_and_generate(self, query, top_k=None):
        if top_k is None:
            top_k = RAG_CONFIG["top_k_documents"]

        if not self.initialized:
            if not self.initialize():
                return {"answer": "AI system not available.", "sources": [], "success": False}

        try:
            search_results = self.search_function(query, top_k)
            if not search_results:
                return {"answer": "I couldn't find relevant documents for your query. Try different keywords.", "sources": [], "success": True}

            context = self._build_context(search_results)
            prompt = f"""
Based on these documents from our plant care knowledge base, answer the question.

=== CONTEXT ===
{context}
=== END CONTEXT ===

QUESTION: {query}

Answer based ONLY on the context above. Cite sources using [Source: filename, Page X].
"""
            response = self.model.generate_content(prompt)
            sources = [{"filename": r["filename"], "page": r["page"], "score": r["score"], "snippet": r["snippet_table"]} for r in search_results]
            return {"answer": response.text, "sources": sources, "success": True}

        except Exception as e:
            return {"answer": f"Error: {str(e)}", "sources": [], "success": False}

# Initialize RAG Engine
rag_engine = RAGSearchEngine(api_key=GEMINI_API_KEY, search_function=search_pages)



class PlantNLTKBot:
    """Simple rule-based bot using NLTK for common plant questions."""

    def __init__(self):
        self.lemmatizer = WordNetLemmatizer()
        try:
            self.stop_words = set(stopwords.words('english'))
        except:
            self.stop_words = set()

        # Define intents with keywords and responses
        self.intents = {
            'greeting': {
                'keywords': ['hello', 'hi', 'hey', 'greetings', 'good morning', 'good evening'],
                'responses': [
                    "Hello! ğŸŒ± I'm your Plant Care Assistant. How can I help you today?",
                    "Hi there! ğŸŒ¿ Ready to help with your plant questions!",
                    "Hey! ğŸª´ What would you like to know about plant care?"
                ]
            },
            'watering': {
                'keywords': ['water', 'watering', 'thirsty', 'dry', 'moisture', 'hydrate', 'drink'],
                'responses': [
                    "ğŸ’§ **Watering Tips:**\n\nâ€¢ Check soil moisture by inserting finger 1-2 inches deep\nâ€¢ Water when top inch feels dry\nâ€¢ Most plants prefer morning watering\nâ€¢ Ensure pots have drainage holes\nâ€¢ Yellow leaves often mean overwatering!",
                ]
            },
            'sunlight': {
                'keywords': ['sun', 'sunlight', 'light', 'shade', 'bright', 'dark', 'window'],
                'responses': [
                    "â˜€ï¸ **Sunlight Guide:**\n\nâ€¢ **Direct sun**: Cacti, succulents (6+ hours)\nâ€¢ **Bright indirect**: Most houseplants (4-6 hours)\nâ€¢ **Low light**: Snake plant, pothos, ZZ plant\nâ€¢ Rotate plants weekly for even growth\nâ€¢ Brown leaf tips may indicate too much direct sun",
                ]
            },
            'yellow_leaves': {
                'keywords': ['yellow', 'yellowing', 'yellow leaves', 'turning yellow'],
                'responses': [
                    "ğŸ‚ **Yellow Leaves - Common Causes:**\n\n1. **Overwatering** (most common!) - Let soil dry out\n2. **Underwatering** - Check soil moisture\n3. **Lack of nutrients** - Consider fertilizing\n4. **Too much direct sun** - Move to indirect light\n5. **Natural aging** - Bottom leaves yellowing is normal",
                ]
            },
            'pests': {
                'keywords': ['pest', 'pests', 'bug', 'bugs', 'insects', 'spider mite', 'aphid', 'fungus gnat'],
                'responses': [
                    "ğŸ› **Pest Control Tips:**\n\nâ€¢ **Spider mites**: Wipe leaves with soapy water\nâ€¢ **Fungus gnats**: Let soil dry between waterings\nâ€¢ **Aphids**: Spray with neem oil solution\nâ€¢ **Mealybugs**: Dab with rubbing alcohol\nâ€¢ Isolate infected plants immediately!",
                ]
            },
            'fertilizer': {
                'keywords': ['fertilizer', 'fertilize', 'feed', 'feeding', 'nutrient', 'nutrients', 'npk'],
                'responses': [
                    "ğŸ§ª **Fertilizing Guide:**\n\nâ€¢ Fertilize during growing season (spring/summer)\nâ€¢ Reduce or stop in winter\nâ€¢ Use balanced fertilizer (10-10-10) for most plants\nâ€¢ Always dilute to half strength\nâ€¢ Never fertilize dry soil - water first!",
                ]
            },
            'repotting': {
                'keywords': ['repot', 'repotting', 'pot', 'container', 'root bound', 'roots'],
                'responses': [
                    "ğŸª´ **Repotting Tips:**\n\nâ€¢ Repot when roots grow out of drainage holes\nâ€¢ Best time: Spring (start of growing season)\nâ€¢ New pot should be 1-2 inches larger\nâ€¢ Use fresh potting mix\nâ€¢ Water thoroughly after repotting\nâ€¢ Avoid fertilizing for 2-4 weeks after",
                ]
            },
            'propagation': {
                'keywords': ['propagate', 'propagation', 'cutting', 'cuttings', 'clone', 'multiply'],
                'responses': [
                    "âœ‚ï¸ **Propagation Methods:**\n\nâ€¢ **Stem cuttings**: Pothos, philodendron\nâ€¢ **Leaf cuttings**: Succulents, snake plant\nâ€¢ **Division**: Peace lily, ferns\nâ€¢ **Water propagation**: Place cutting in water until roots form\nâ€¢ Use rooting hormone for faster results",
                ]
            },
            'soil': {
                'keywords': ['soil', 'dirt', 'potting mix', 'drainage', 'perlite'],
                'responses': [
                    "ğŸŒ **Soil Guide:**\n\nâ€¢ **Standard mix**: All-purpose potting soil\nâ€¢ **Succulents**: Add sand/perlite for drainage\nâ€¢ **Tropical**: Add peat moss for moisture\nâ€¢ **Orchids**: Use bark-based mix\nâ€¢ Never use garden soil in pots!",
                ]
            },
            'humidity': {
                'keywords': ['humidity', 'humid', 'mist', 'misting', 'dry air', 'tropical'],
                'responses': [
                    "ğŸ’¨ **Humidity Tips:**\n\nâ€¢ Group plants together to increase humidity\nâ€¢ Use a pebble tray with water\nâ€¢ Mist tropical plants (but not fuzzy leaves!)\nâ€¢ Consider a humidifier in winter\nâ€¢ Bathrooms are great for humidity-loving plants",
                ]
            },
            'goodbye': {
                'keywords': ['bye', 'goodbye', 'thanks', 'thank you', 'exit', 'quit'],
                'responses': [
                    "Goodbye! ğŸŒ± Happy growing!",
                    "Take care of your plants! ğŸª´ See you soon!",
                    "Bye! ğŸŒ¿ Remember: when in doubt, don't water! ğŸ˜„"
                ]
            },
            'help': {
                'keywords': ['help', 'what can you do', 'commands', 'options'],
                'responses': [
                    "ğŸ¤– **I can help you with:**\n\nâ€¢ ğŸ’§ Watering tips\nâ€¢ â˜€ï¸ Sunlight requirements\nâ€¢ ğŸ‚ Yellow leaves diagnosis\nâ€¢ ğŸ› Pest control\nâ€¢ ğŸ§ª Fertilizing\nâ€¢ ğŸª´ Repotting\nâ€¢ âœ‚ï¸ Propagation\nâ€¢ ğŸŒ Soil types\nâ€¢ ğŸ’¨ Humidity\n\nJust ask me anything about plants!",
                ]
            }
        }

    def preprocess(self, text):
        """Tokenize and lemmatize the input text."""
        tokens = word_tokenize(text.lower())
        processed = [
            self.lemmatizer.lemmatize(token)
            for token in tokens
            if token.isalnum() and token not in self.stop_words
        ]
        return processed

    def detect_intent(self, text):
        """Detect the intent of the user's message."""
        processed = self.preprocess(text)
        text_lower = text.lower()

        best_intent = None
        best_score = 0

        for intent, data in self.intents.items():
            score = 0
            for keyword in data['keywords']:
                if keyword in text_lower:
                    score += 2
                elif keyword in processed:
                    score += 1

            if score > best_score:
                best_score = score
                best_intent = intent

        if best_score >= 2:
            return best_intent, best_score
        return None, 0

    def get_response(self, text):
        """Get a response for the given text."""
        intent, score = self.detect_intent(text)

        if intent:
            responses = self.intents[intent]['responses']
            return random.choice(responses), True

        return None, False


class PlantGeminiBot:
    """Advanced bot using Google's Gemini API for complex questions."""

    def __init__(self, api_key):
        self.api_key = api_key
        self.model = None
        self.chat = None
        self.initialized = False

    def initialize(self):
        """Initialize the Gemini model."""
        try:
            genai.configure(api_key=self.api_key)

            generation_config = {
                "temperature": 0.7,
                "top_p": 0.95,
                "top_k": 40,
                "max_output_tokens": 1024,
            }

            system_instruction = """
            You are 'Plant Bot' ğŸŒ±, an AI expert within the 'Chameleon' smart plant system.

            Your Role:
            1. Provide concise, friendly, and practical gardening advice.
            2. Use emojis to make the conversation engaging.
            3. If the user asks about their specific plant, ask them to check the 'Soil' or 'Climate' tabs if you don't have the data.
            4. Keep responses under 200 words unless asked for a detailed guide.
            5. Format lists with bullet points.
            6. Language: If the user speaks Hebrew, reply in Hebrew. If English, reply in English.

            Critical Rule: Never invent sensor readings. If you don't know the soil moisture, ask the user to check the sensor graph.
            """

            self.model = genai.GenerativeModel(
                model_name="gemini-2.5-flash",
                generation_config=generation_config,
                system_instruction=system_instruction
            )

            self.chat = self.model.start_chat(history=[])
            self.initialized = True
            return True

        except Exception as e:
            print(f"Error initializing Gemini: {e}")
            return False

    def get_response(self, text):
        """Get a response from Gemini API."""
        if not self.initialized:
            if not self.initialize():
                return "Sorry, I couldn't connect to my AI brain. Please check the API key.", False

        try:
            response = self.chat.send_message(text)
            return response.text, True
        except Exception as e:
            return f"Sorry, I encountered an error: {str(e)}", False


class HybridPlantBot:
    """Combines NLTK for fast responses and Gemini for complex queries."""

    def __init__(self, gemini_api_key=None):
        self.nltk_bot = PlantNLTKBot()
        self.gemini_bot = None
        self.gemini_enabled = False

        if gemini_api_key:
            self.gemini_bot = PlantGeminiBot(gemini_api_key)
            self.gemini_enabled = True

    def get_response(self, text):
        """Get response using hybrid approach."""
        # First, try NLTK
        response, handled = self.nltk_bot.get_response(text)

        if handled:
            return response, "nltk"

        # If NLTK couldn't handle it and Gemini is enabled
        if self.gemini_enabled and self.gemini_bot:
            response, success = self.gemini_bot.get_response(text)
            if success:
                return response, "gemini"

        # Fallback response
        return "I'm not sure about that. Try asking about watering, sunlight, pests, or fertilizing! ğŸŒ±", "fallback"


def plant_bot_screen():
    """Plant Bot Chat Interface."""

    # Initialize the hybrid bot
    bot = HybridPlantBot(gemini_api_key=GEMINI_API_KEY if GEMINI_API_KEY else None)

    # Chat history storage
    chat_history = []

    # CSS Styles
    display(HTML("""
    <style>
        .chat-container {
            background: white;
            border-radius: 20px;
            width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            color: black;
        }
        .message.user {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .message.bot .message-avatar {
            background: #E3F4E0;
            margin-right: 10px;
        }
        .message.user .message-avatar {
            background: #E3F2FD;
            margin-left: 10px;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.5;
        }
        .message.bot .message-bubble {
            background: white;
            border: 1px solid #eee;
            border-top-left-radius: 5px;
        }
        .message.user .message-bubble {
            background: #2C5F4B;
            color: white;
            border-top-right-radius: 5px;
        }
        .source-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 5px;
            display: inline-block;
        }
        .source-nltk {
            background: #FFF3CD;
            color: #856404;
        }
        .source-gemini {
            background: #D4EDDA;
            color: #155724;
        }
        .quick-reply-btn {
            background: #E3F4E0 !important;
            color: #2C5F4B !important;
            border: none !important;
            border-radius: 15px !important;
            padding: 6px 12px !important;
            font-size: 12px !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
        }
        .quick-reply-btn:hover {
            background: #2C5F4B !important;
            color: white !important;
        }
    </style>
    """))

    # UI Components
    header_html = widgets.HTML("""
        <div style='
            background: linear-gradient(135deg, #2C5F4B 0%, #1F4D36 100%);
            color: white;
            padding: 20px;
            text-align: center;
        '>
            <div style='font-size: 40px; margin-bottom: 5px;'>ğŸŒ±</div>
            <h2 style='margin: 0; font-size: 20px;'>Plant Bot</h2>
            <p style='margin: 5px 0 0 0; opacity: 0.8; font-size: 13px;'>Your AI Plant Care Assistant</p>
        </div>
    """)

    messages_out = widgets.Output(layout=widgets.Layout(
        height='350px',
        overflow_y='auto',
        padding='15px'
    ))

    user_input = widgets.Text(
        placeholder='Ask me anything about plants...',
        layout=widgets.Layout(width='650px', height='45px')
    )

    send_btn = widgets.Button(
        description='Send',
        button_style='success',
        layout=widgets.Layout(width='100px', height='45px')
    )

    def add_message(text, is_user=False, source=None):
        """Add a message to the chat display."""
        with messages_out:
            if is_user:
                display(HTML(f"""
                    <div class='message user'>
                        <div class='message-bubble'>{html.escape(text)}</div>
                        <div class='message-avatar'>ğŸ‘¤</div>
                    </div>
                """))
            else:
                formatted_text = text.replace('\n', '<br>')
                formatted_text = re.sub(r'\*\*(.*?)\*\*', r'<strong>\1</strong>', formatted_text)

                source_badge = ""
                if source == "nltk":
                    source_badge = "<span class='source-badge source-nltk'>âš¡ Quick Response</span>"
                elif source == "gemini":
                    source_badge = "<span class='source-badge source-gemini'>ğŸ¤– AI Response</span>"

                display(HTML(f"""
                    <div class='message bot'>
                        <div class='message-avatar'>ğŸŒ±</div>
                        <div class='message-bubble'>
                            {formatted_text}
                            <br>{source_badge}
                        </div>
                    </div>
                """))

    def on_send(b):
        """Handle send button click."""
        text = user_input.value.strip()
        if not text:
            return

        user_input.value = ''
        add_message(text, is_user=True)
        chat_history.append({"role": "user", "text": text})

        # Get bot response
        response, source = bot.get_response(text)

        add_message(response, is_user=False, source=source)
        chat_history.append({"role": "bot", "text": response, "source": source})

    def on_quick_reply(term):
        """Handle quick reply button click."""
        def handler(b):
            user_input.value = term.split(' ', 1)[1] if ' ' in term else term
            on_send(None)
        return handler

    send_btn.on_click(on_send)
    try:
        user_input.on_submit(on_send)
    except:
        pass

    # Quick reply buttons
    quick_replies = ['ğŸ’§ Watering tips', 'â˜€ï¸ Sunlight guide', 'ğŸ‚ Yellow leaves', 'ğŸ› Pest help', 'â“ Help']
    quick_btns = []
    for term in quick_replies:
        btn = widgets.Button(description=term, layout=widgets.Layout(height='30px', width='auto'))
        btn.add_class('quick-reply-btn')
        btn.on_click(on_quick_reply(term))
        quick_btns.append(btn)

    quick_row = widgets.HBox(quick_btns, layout=widgets.Layout(
        justify_content='center',
        padding='10px',
        gap='8px'
    ))

    # Initial welcome message
    with messages_out:
        welcome_msg = "Hello! ğŸŒ± I'm Plant Bot, your plant care assistant!\n\nI can help you with watering, sunlight, pests, fertilizing, and more. What would you like to know?"
        add_message(welcome_msg, is_user=False, source="nltk")

    # API status
    api_status = "ğŸŸ¢ AI Enabled (Gemini)" if GEMINI_API_KEY else "ğŸŸ¡ Basic Mode (Add Gemini API key for full AI)"
    status_html = widgets.HTML(f"""
        <div style='text-align: center; padding: 8px; background: #f8f9fa; font-size: 11px; color: #666;'>
            {api_status}
        </div>
    """)

    # Layout
    input_row = widgets.HBox([
        user_input,
        send_btn
    ], layout=widgets.Layout(
        padding='15px 20px',
        gap='10px',
        justify_content='center'
    ))

    chat_card = widgets.VBox([
        header_html,
        messages_out,
        quick_row,
        input_row,
        status_html
    ], layout=widgets.Layout(
        width='800px',
        background='white',
        border_radius='20px',
        box_shadow='0 4px 20px rgba(0,0,0,0.08)'
    ))

    return widgets.VBox([
        chat_card
    ], layout=widgets.Layout(
        align_items='center',
        padding='20px'
    ))

"""---
# 13. Main Application (Navigation & Game)

### Navigation
The navbar has buttons for all screens. Clicking a button calls `show_in_container()` which replaces the main content.

### Gamification
The Game screen shows:
- Current level and XP progress
- Coin balance
- Available missions that link to other screens

**Rewards:**
- Upload image: +15 XP, +5 coins
- Log activity: +10 XP, +5 coins
- Analyze plant: +5 XP, +5 coins
- Search: +5 XP, +2 coins

Level = XP / 100 + 1

"""

#container style
container_style = {
    'border': '2px solid white',
    'padding': '20px',
    'width': '100%',
    'height': '100%',
    'margin': 'auto',
    'overflow_y': 'auto',
    'align_items': 'center',
    'box-sizing': 'border-box'
}


logo = widgets.HTML(
    """
    <div style='
        width: 50px;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.2);
    '>
        ğŸ¦
    </div>
    """
)

# ==========================================================
# MAIN CONTAINER AND NAVIGATION
# ==========================================================

# Main container for the whole app
main_container = widgets.VBox(layout=widgets.Layout(**container_style))
main_container.add_class("main-container")

# Change background color
display(HTML("""
<style>
.main-container {
    background-color: #FAFDF9;
}
</style>
"""))

display(main_container)

# Navigation buttons
tab_buttons = [
    widgets.Button(description="Home"),
    widgets.Button(description="My Plants"),
    widgets.Button(description="Soil"),
    widgets.Button(description="Climate"),
    widgets.Button(description="Search"),
    widgets.Button(description="Logbook"),
    widgets.Button(description="Plant Bot"),
    widgets.Button(description="Game"),  # New Game tab
]

for button in tab_buttons:
    button.add_class("nav-btn")

buttons_box = widgets.HBox(tab_buttons, layout=widgets.Layout(gap='10px'))

nav_bar = widgets.HBox(
    [logo, buttons_box],
    layout=widgets.Layout(
        width='100%',
        justify_content='space-between',
        align_items='center',
        padding='10px 40px 10px 40px',
        height='70px'
    )
)
nav_bar.add_class("nav-bar-container")

# Navbar styling
display(HTML("""
<style>
.nav-bar-container {
    background: linear-gradient(90deg, #1F4D36 0%, #2C5F4B 100%);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 30px;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.nav-btn {
    background-color: transparent !important;
    color: #F0F7F4 !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    border: none !important;
    border-radius: 20px !important;
    padding: 0 20px !important;
    height: 35px !important;
    transition: all 0.3s ease !important;
    outline: none !important;
    box-shadow: none !important;
}

.nav-btn:hover {
    background-color: rgba(255, 255, 255, 0.2) !important;
    transform: translateY(-2px);
    color: white !important;
}

.nav-btn:active, .nav-btn:focus {
    background-color: rgba(255, 255, 255, 0.3) !important;
    transform: translateY(0);
}
</style>
"""))

# Function to show a screen in main container
def show_in_container(func):
    content = func()
    main_container.children = [nav_bar, content]


# ==========================================================
# TASKS MAPPING
# ==========================================================

tasks_rewards = {
    "log": {"xp": 10, "coins": 5, "screen": logbook_screen},
    "search": {"xp": 5, "coins": 2, "screen": search_screen},
    "analyze_plant_image": {"xp": 5, "coins": 5, "screen": upload_screen},
    "upload": {"xp": 15, "coins": 5, "screen": upload_screen}
}

# Function to perform a task (to be called AFTER completing it on the target screen)
def perform_task(task_key):
    task = tasks_rewards[task_key]
    add_reward(task["xp"], task["coins"])
    # Refresh game screen after updating points
    show_in_container(game_screen)


# ==========================================================
# GAME SCREEN
# ==========================================================

def game_screen():
    # Get user stats
    stats = FBconn.get('/user_stats', None) or {"points": 0, "coins": 0}
    points = stats.get('points', 0)
    coins = stats.get('coins', 0)
    level = (points // 100) + 1
    progress = points % 100

    # --- HTML layout for XP and Level ---
    html_layout = f"""
    <div style="
        background: linear-gradient(135deg, #1F4D36, #2C5F4B);
        padding: 25px; border-radius: 20px; text-align: center;
        color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2); max-width: 700px; margin: auto;">

        <h2 style="margin:0; letter-spacing: 2px; color: #ffeaa7;">ğŸ† Garden Guardian Hub</h2>
        <div style="margin: 15px 0; font-weight: bold; font-size:16px;">
            Level {level} Expert | ğŸ’° {coins} Coins
        </div>

        <div style="background: rgba(255,255,255,0.2); border-radius: 50px; height: 22px; width: 90%; margin: 10px auto; overflow: hidden;">
            <div style="background: #00d084; height: 100%; width: {progress}%; border-radius: 50px; box-shadow: 0 0 15px #00cec9; transition: width 0.8s ease-in-out;"></div>
        </div>
        <p style="font-size: 13px; opacity: 0.9;">Current XP: {points} - Reach {100-progress} more XP for Level {level+1}</p>
    </div>

    <div style="text-align:center; margin: 25px 0;">
        <h4 style="color: #2d3436; text-transform: uppercase; border-bottom: 2px solid #00b894; display: inline-block; padding-bottom: 5px;">Available Missions</h4>
    </div>
    """

    # --- Mission buttons
    missions = [
        {"desc": "ğŸ“ Log Your Garden Activity\nGain XP!", "screen": tasks_rewards["log"]["screen"]},
        {"desc": "ğŸ” Explore Library\nBoost Coins!", "screen": tasks_rewards["search"]["screen"]},
        {"desc": "ğŸŒ± Analyze plant\nHelp Your Plants!", "screen": tasks_rewards["analyze_plant_image"]["screen"]},
        {"desc": "ğŸ“· Upload Plant Image\nEarn Big Rewards!", "screen": tasks_rewards["upload"]["screen"]}
    ]

    buttons = []
    for m in missions:
        btn = widgets.Button(
            description=m["desc"],
            layout=widgets.Layout(width='280px', height='100px', margin='10px'),
            style={'button_color': '#00d084'}
        )
        btn.add_class("game-mission-btn")
        btn.on_click(lambda b, screen=m["screen"]: show_in_container(screen))
        buttons.append(btn)

    # --- Arrange buttons in a 2x2 grid ---
    grid_rows = []
    for i in range(0, len(buttons), 2):
        row = widgets.HBox(buttons[i:i+2], layout=widgets.Layout(justify_content='center'))
        grid_rows.append(row)

    # --- Add CSS for hover effect ---
    display(HTML("""
    <style>
    .game-mission-btn {
        font-weight: bold;
        font-size: 14px;
        border-radius: 15px !important;
        color: #2d3436 !important;
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        white-space: pre-line;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .game-mission-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.25);
        background: linear-gradient(135deg, #00e096, #00d084) !important;
        color: #fff !important;
    }
    </style>
    """))

    # --- Compose full screen ---
    return widgets.VBox(
        [widgets.HTML(html_layout)] + grid_rows,
        layout=widgets.Layout(align_items='center', width='100%', padding='10px')
    )

# ==========================================================
# CONNECT NAVIGATION BUTTONS
# ==========================================================

tab_buttons[0].on_click(lambda b: show_in_container(home_screen))
tab_buttons[1].on_click(lambda b: show_in_container(upload_screen))
tab_buttons[2].on_click(lambda b: show_in_container(soil_screen))
tab_buttons[3].on_click(lambda b: show_in_container(climate_screen))
tab_buttons[4].on_click(lambda b: show_in_container(search_screen))
tab_buttons[5].on_click(lambda b: show_in_container(logbook_screen))
tab_buttons[6].on_click(lambda b: show_in_container(plant_bot_screen))
tab_buttons[7].on_click(lambda b: show_in_container(game_screen))

# ==========================================================
# SHOW INITIAL SCREEN
# ==========================================================

main_container.children = [nav_bar, home_screen()]

"""---
## ğŸ“Š Summary

### âœ… Features Implemented

| Feature | Technology | Description |
|---------|------------|-------------|
| Sensor Monitoring | Firebase + Render API | Real-time temp, humidity, soil data |
| Disease Detection | Hugging Face MobileNetV2 | AI image classification |
| Search Engine | TF-IDF + Inverted Index | Hybrid retrieval + ranking |
| Chatbot | NLTK + Google Gemini | Hybrid quick + AI responses |
| Activity Logging | Firebase | Track plant care activities |
| Gamification | Firebase | XP, coins, levels, missions |

### ğŸ—ï¸ Architecture Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRONTEND      â”‚     â”‚   BACKEND       â”‚     â”‚   AI/ML         â”‚
â”‚   (ipywidgets)  â”‚ â—„â”€â–º â”‚   (Firebase)    â”‚ â—„â”€â–º â”‚   (HuggingFace) â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚   (Gemini)      â”‚
â”‚   â€¢ UI screens  â”‚     â”‚   â€¢ Realtime DB â”‚     â”‚   â€¢ MobileNetV2 â”‚
â”‚   â€¢ Charts      â”‚     â”‚   â€¢ Data sync   â”‚     â”‚   â€¢ TF-IDF      â”‚
â”‚   â€¢ Navigation  â”‚     â”‚   â€¢ Persistence â”‚     â”‚   â€¢ NLTK        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸš€ How to Run
1. Run all cells in order (Ctrl+F9)
2. Wait for models to load
3. App displays at the bottom
4. Use navigation bar to explore features

### ğŸ“ Notes
- First run downloads ~500MB of models
- Index is built once, reused on subsequent runs
- All data persists in Firebase between sessions

"""